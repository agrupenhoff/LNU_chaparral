---
title: "LNU Analysis"
author: "Ashley Grupenhoff"
date: "5/6/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/ashle/OneDrive/Documents/R/LNU_chaparral/LNU_chaparral")
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(plyr)
library(brms)
library(rstan)
library(tidybayes)
library(bayesplot)
library(bayestestR)
library(emmeans)
library(calecopal)
library(modelr)
library(ROCR) #calculate area under curve

library(broom)            # Convert model objects to data frames
library(broom.mixed)   

#run faster
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

```

## Input clean data
```{r data}
#raw
TOT_species_LNU <- read.csv("data/raw/TOT_species_LNU.csv")
subplot_species_LNU <- read.csv("data/raw/SubPlot_SPP_LNU.csv")
severity_LNU <- read.csv("data/raw/Severity_LNU.csv")
GroundCover_LNU <- read.csv("data/raw/GroundCover_LNU.csv")
Mortality_LNU <- read.csv("data/raw/Mortality_LNU.csv")

plot.description_LNU <- read.csv("data/clean/LNU_plot_description_CLEAN.csv")
SpeciesList <- read.csv("data/raw/SpeciesList_jan23.csv")

species.short <- SpeciesList %>% 
  dplyr::select(spp, Lifeform, Native_nonnative, fac.obl) 


plyr::count(plot.description_LNU$cool_warm_slope)

```


## Severity 

```{r severity}


severity_LNU_clean <- severity_LNU %>% 
  group_by(PlotID, year) %>% 
  dplyr::summarise(mean_diam_mm = mean(Mean_diam),
            sd = sd(Mean_diam),
            n_obs = n(),
            se = sd/sqrt(n_obs))

severity.plotdescription.LNU <- left_join(severity_LNU_clean, 
                                          plot.description_LNU, by="PlotID")


sevdata <- ddply(severity.plotdescription.LNU, c("num_burn"),
                 summarise,
                 N = sum(!is.na(mean_diam_mm)),
                 mean_diam_mm_avg = mean(mean_diam_mm, na.rm=TRUE),
                 sd= sd(mean_diam_mm, na.rm = TRUE),
                 se = sd/sqrt(N)) 


ggplot(data=sevdata %>%  
         filter(num_burn != "2"), 
       aes(x=as.factor(num_burn), y=mean_diam_mm_avg))+
  geom_bar(stat = "identity", aes(fill= as.factor(num_burn)))+
  geom_errorbar(aes(ymin=mean_diam_mm_avg-se, ymax=mean_diam_mm_avg+se), width=.1, size=.7)+
  #geom_point(size=3, aes(colour=factor(num_burn)))+
  scale_fill_manual(values = cal_palette("sierra1")) +
                     xlab("Fire frequency")+
                     ylab("Fire Severity (mm)")+
                    theme_bw()+
                   theme(legend.title = element_blank(),
                           axis.text = element_text(size=15),
                            text = element_text(size = 16),
                          panel.grid = element_blank())
ggsave(file="figures/sev~freq.svg", width = 4.5, height = 3)
ggsave(file="figures/sev~freq.png", width = 4.5, height = 3)





#LINEAR MODEL
qqnorm(severity.plotdescription.LNU$mean_diam_mm, pch = 1, frame = FALSE)
qqline(severity.plotdescription.LNU$mean_diam_mm, col = "steelblue", lwd = 2)

m.sev <- lm(num_burn ~ mean_diam_mm ,
                 data = severity.plotdescription.LNU, REML = F)
summary(m.sev)
coef(summary(m.nativeRich))
plot(m.sev)

```



# NMDS
xxxxxxxxx
This file is not up to date
xxxxxxxxxxx

```{r}
library(vegan)

load(file = "data/clean/LNU_subplot_wide_species.RData")

#make community matrix on which to base ordination
LNUspecies = LNU_subplot_wide %>% select(!PlotID)
#columns that contain descriptive data
LNUplot_ord = LNU_subplot_wide %>% 
  select(PlotID) 
LNUplot_env <- left_join(LNUplot_ord, plot.description.short %>% distinct(), by = "PlotID")

set.seed(123) #reproduce same results
NMDS <- metaMDS(LNUspecies, distance="bray", k=2) #no transformation of species data is made here prior to bray curtis dissimilarities being calculated. 
NMDS

#env.fit
nmds_plot <- cbind(NMDS$point, LNUplot_env)
nmds_species <- left_join(cbind(as.data.frame(NMDS$species), 
                                as.data.frame(row.names(as.data.frame(NMDS$species)))), 
                               # %>% rename(spp = "row.names(as.data.frame(NMDS$species))")
                                species.short, by = c("row.names(as.data.frame(NMDS$species))"="spp" ))

nmds_plot$num_burn <- as.factor(nmds_plot$num_burn)

ggplot(nmds_plot %>% filter(num_burn != "7"), aes(x=MDS1, y=MDS2))+
  geom_point(size = 4, aes(x=MDS1, y=MDS2, color = num_burn))+
  #geom_point(data= nmds_species, size = 1.8, alpha = 0.5, aes(x=MDS1, y=MDS2, 
  #                                               shape = Native_nonnative))
  stat_ellipse(aes(x=MDS1, y=MDS2, color = num_burn))+
  scale_color_viridis_d()+
  guides(col=guide_legend("Fire Frequency"))+
  theme(axis.text = element_text(size=15),
        text = element_text(size = 16),
        panel.grid = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size=11))
ggsave(file="figures/NMDS.svg", width = 5, height = 3)
ggsave(file="figures/NMDS.png", width = 5, height = 3)



```



# prepare Richness file

Calculated richness by each sub plot probably want to do this by total plot?

```{r Richness, echo=FALSE}
#calculate richness

LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")

#sum up the number of non-zero entries per row 
#first column ignored ([,-1]) since this is the site name, not species count
LNU_richness_nonnative <- ddply(LNU_sub_nonnative_wide,~plot_yr_quad,function(x) {
  data.frame(NONNATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness_native <- ddply(LNU_sub_native_wide,~plot_yr_quad,function(x) {
  data.frame(NATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness <- left_join(LNU_richness_native, LNU_richness_nonnative, by="plot_yr_quad")

LNU_richness_proportion <- LNU_richness %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  mutate(prop.native = (NATIVE_RICHNESS/(NATIVE_RICHNESS + NONNATIVE_RICHNESS))) %>% 
  separate(plot_yr_quad, c("plot_year", "quad"), sep=" ") %>% 
  group_by(plot_year) %>% 
  dplyr::summarise(mean_native_rich = mean(NATIVE_RICHNESS),
            mean_nonnative_rich = mean(NONNATIVE_RICHNESS),
            mean_propNative = mean(prop.native))
  

LNU_richness_final <- LNU_richness_proportion %>% 
  pivot_longer(!plot_year,
               names_to = "native.nonnative.prop",
               values_to = "richness") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

LNU_richness_final <- left_join(LNU_richness_final, plot.description_LNU, by="PlotID")


write_csv(LNU_richness_final, "data/clean/LNU_subplot_RICHNESS.csv")
            
```

#prepare total cover file (proportion)

```{r}
LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")
str(LNU_sub_nonnative_wide)

LNU_nonnative <- LNU_sub_nonnative_wide %>% 
    dplyr::select(!(X)) %>% 
    dplyr::mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   dplyr::select(plot_yr_quad, sum) %>% 
    dplyr::rename(nonnative_cover = sum)

LNU_native <- LNU_sub_native_wide %>% 
    dplyr::select(!(X)) %>% 
    dplyr::mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   dplyr::select(plot_yr_quad, sum) %>% 
    dplyr::rename(native_cover = sum)

LNU_cover <- left_join(LNU_native, LNU_nonnative, by="plot_yr_quad")
head(LNU_cover)

LNU_cover_clean <- LNU_cover %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  separate(plot_yr_quad, c("plot_year", "quad"), sep=" ") %>% 
  group_by(plot_year) %>% 
  dplyr::summarise(mean_native_cover= mean(native_cover),
                   mean_nonnative_cover = mean(nonnative_cover),
                   sum_native_cover = sum(native_cover),
                   sum_nonnative_cover = sum(nonnative_cover)) %>% 
   mutate(prop_native_cover = (mean_native_cover/
                                 (mean_native_cover + mean_nonnative_cover))) %>% 
   pivot_longer(!plot_year,
               names_to = "native.nonnative.prop",
               values_to = "cover") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

plot(LNU_cover_clean$prop_native_cover)

LNU_cover_final <- left_join(LNU_cover_clean, plot.description_LNU, by="PlotID")

write_csv(LNU_cover_final, "data/clean/LNU_speciesCover_FINAL.csv")

str(LNU_cover_final)
LNU_cover_final$num_burn <- as.factor(LNU_cover_final$num_burn)

LNU_cover_final %>% 
  filter(native.nonnative.prop == "prop_native_cover" &
          PFR == "chaparral and serotinous conifer") %>% 
  ggplot(aes(x= num_burn, y = cover))+
  geom_boxplot()





```


# model richness regression 

```{r regression RICH}


LNU_richness <- read.csv("data/clean/LNU_subplot_RICHNESS.csv")

propnativeRich <- LNU_richness %>% 
  filter(native.nonnative.prop == "mean_propNative")  %>% 
  filter(PFR != "oak woodland") %>% 
 # filter(Site != "CacheCreek") %>% 
  dplyr::rename(prop_native_rich = richness)

str(propnativeRich)
propnativeRich$num_burn <- as.factor(propnativeRich$num_burn)
propnativeRich$TSLF <- as.factor(propnativeRich$TSLF)
propnativeRich$mCC_FRI <- as.factor(propnativeRich$mCC_FRI)
propnativeRich$aspect_name <- as.factor(propnativeRich$aspect_name)
propnativeRich$year <- as.factor(propnativeRich$year)
propnativeRich$elevation <- as.numeric(propnativeRich$elevation)
propnativeRich$crrnFRI <- as.factor(propnativeRich$crrnFRI)
propnativeRich$cool_warm_slope <- as.factor(propnativeRich$cool_warm_slope)
propnativeRich$Geology <- as.factor(propnativeRich$Geology)



str(LNU_richness)
unique(LNU_richness$native.nonnative.prop)

##BAYESIAN
#repeated measures looking at richness based on different fire frequencies 

ggplot(propnativeRich, aes(x=num_burn, y=prop_native_rich,
                           fill = cool_warm_slope))+
  geom_boxplot()
ggplot(propnativeRich, aes(x=num_burn, y=prop_native_rich,
                           color = hli))+
  geom_point()

str(propnativeRich)
propnativeRich$num_burn <- as.factor(propnativeRich$num_burn)

propnativeRich_small <- propnativeRich %>% 
  dplyr::select(prop_native_rich, year, Site, num_burn, mCC_FRI, TSLF,
         ppt, tmean, elevation, slope, Distance_km, hli,
         Geology, aspect_name, cool_warm_slope) %>% 
  #can't have exactly 0 or 1
  mutate(prop_native_rich = ifelse(prop_native_rich == 1, 0.999, prop_native_rich))

range(propnativeRich_small$prop_native_rich)
#check if covariates are correlated
hist(propnativeRich$prop_native_rich)
plot(propnativeRich$ppt, propnativeRich$tmean)
plot(propnativeRich$ppt, propnativeRich$hli)
plot(propnativeRich$tmean, propnativeRich$hli)
plot(propnativeRich$TSLF, propnativeRich$num_burn)
plot(propnativeRich$hli, propnativeRich$aspect_name)
plot(propnativeRich$crrnFRI, propnativeRich$num_burn)
plot(propnativeRich$num_burn, propnativeRich$prop_native_rich)
plot(propnativeRich$TSLF, propnativeRich$prop_native_rich)
plot(propnativeRich$ppt, propnativeRich$prop_native_rich)
plot(propnativeRich$cool_warm_slope, propnativeRich$prop_native_rich)
plot(propnativeRich$prop_native_rich)

str(propnativeRich_small)
data <- propnativeRich_small[ , c("ppt", "tmean", "elevation", "slope", "hli")]
cor(data) #this looks good!!

#determine outliers 
min(propnativeRich_small$prop_native_rich) #0.217
max(propnativeRich_small$prop_native_rich) #1
mean(propnativeRich_small$prop_native_rich) #0.52
ggplot(propnativeRich_small) +
  aes(x = "", y = prop_native_rich) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()

hist(propnativeRich$prop_native_rich)


m.propnatRich <- brm(
  bf(prop_native_rich ~ 1 + num_burn, 
     phi ~ num_burn),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich, file= "models/nativeRich_feb23.rda")
load("models/nativeRich_feb23.rda")

tidy(m.propnatRich, effects = "fixed")
summary(m.propnatRich)
conditional_effects(m.propnatRich)
bayes_R2(m.propnatRich)
plot(m.propnatRich)
pp_check(m.propnatRich)

# Plug a dataset where quota is FALSE and TRUE into the model
beta_bayes_pred <- m.propnatRich %>% 
  epred_draws(newdata = tibble(num_burn = unique(propnativeRich$num_burn)))

ggplot(beta_bayes_pred, aes(x = num_burn, y = .epred, fill = num_burn)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi") +
  scale_fill_manual(values = cal_palette("sierra1")) +
  labs(x= "Predicted proportion of native species", y = NULL,
       caption = "80% and 95% credible intervals shown in black")


m.propnatRich2 <- brm(
  bf(prop_native_rich ~ 1 + num_burn * year, 
     phi ~ num_burn * year),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich2, file = "models/nativeRich2_feb23.rda")
load("models/nativeRich2_feb23.rda")

loo(m.propnatRich, m.propnatRich2)
summary(m.propnatRich2)
conditional_effects(m.propnatRich2)
pp_check(m.propnatRich2)
plot(m.propnatRich2)
bayes_R2(m.propnatRich2)
# Plug a dataset where quota is FALSE and TRUE into the model
beta_bayes_pred <- m.propnatRich2b %>% 
  epred_draws(newdata = expand_grid(num_burn = unique(propnativeRich$num_burn),
                                    year = unique(propnativeRich$year))) 


ggplot(beta_bayes_pred, aes(x = num_burn, y = .epred, fill = year)) +
  #stat_pointinterval(position = position_dodge(width = .4),
  #                               .width = c(0.95))+
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi") +
  scale_fill_manual(values = cal_palette("sierra1")) +
  labs(y = "Predicted proportion of native species", x = NULL,
       caption = "80% and 95% credible intervals shown in black")

m.propnatRich2b <- brm(
  bf(prop_native_rich ~ 1 + num_burn + year, 
     phi ~ num_burn + year),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich2b, file = "models/nativeRich2b_feb23.rda")
#load("models/nativeRich2_feb23.rda")
loo(m.propnatRich2, m.propnatRich2b)
summary(m.propnatRich2b)
conditional_effects(m.propnatRich2b)

m.propnatRich3 <- brm(
  bf(prop_native_rich ~ 1 + num_burn * year + hli, 
     phi ~ num_burn * year + hli),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich3, file = "models/nativeRich3_feb23.rda")
load("models/nativeRich3_feb23.rda")

loo(m.propnatRich, m.propnatRich2b, m.propnatRich3)
summary(m.propnatRich3)
conditional_effects(m.propnatRich3)
bayes_R2(m.propnatRich3)

# Plug a dataset where quota is FALSE and TRUE into the model
range(propnativeRich_small$hli)
mean(propnativeRich$hli)
beta_bayes_pred <- m.propnatRich3 %>% 
  epred_draws(newdata = expand_grid(num_burn = unique(propnativeRich$num_burn),
                                    year = unique(propnativeRich$year),
                                    hli = c(.7))) 


ggplot(beta_bayes_pred, aes(x = num_burn, y = .epred)) +
  #stat_pointinterval(position = position_dodge(width = .4),
  #                              .width = c(0.95))+
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi") +
  scale_fill_manual(values = cal_palette("sierra1")) +
  labs(y = "Predicted proportion of native species", x = NULL,
       caption = "80% and 95% credible intervals shown in black")


m.propnatRich4 <- brm(
  bf(prop_native_rich ~ 1 + num_burn * year + hli + ppt, 
     phi ~ num_burn * year + hli + ppt),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich4, file = "models/nativeRich4_feb23.rda")
load("models/nativeRich4_feb23.rda")

loo(m.propnatRich,m.propnatRich2,  m.propnatRich3, m.propnatRich4)
summary(m.propnatRich4)
conditional_effects(m.propnatRich4)
bayes_R2(m.propnatRich4)

# Plug a dataset where quota is FALSE and TRUE into the model
range(propnativeRich_small$hli)
range(propnativeRich_small$ppt)
beta_bayes_pred <- m.propnatRich4 %>% 
    epred_draws(newdata = expand_grid(num_burn = unique(propnativeRich$num_burn),
                                    year = unique(propnativeRich$year),
                                    hli = c(.3:1),
                                    ppt = c(700))) 
head(beta_bayes_pred)



ggplot(beta_bayes_pred, aes(x = num_burn, y = .epred, 
                            color = num_burn)) +
  stat_pointinterval(position = position_dodge(width = .4),
                                 .width = c(0.95))+
 # stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi") +
  scale_color_manual(values = cal_palette("sierra1")) +
  labs(x = "Predicted proportion of native species (richness)", y = NULL,
       caption = "80% and 95% credible intervals shown in black")



```

# model p(cover) brms - COMPLETE 

final model beta binomial p(native cover) ~ 1 + num_burn + year 
phi ~ 1+num_burn + year

Model comparisons:
                        elpd_diff se_diff
m.prop.cover.rich         0.0       0.0  
m.prop.cover.rich_year   -6.8       6.3  
m.prop.cover.rich_hli   -10.2       5.9  
m.prop.cover.rich_ppt   -13.6       6.0  
m.prop.cover.rich_tmean -14.0       7.3  
m.prop.cover.rich_slope -14.5       6.5 

```{r}
LNU_cover_final <- read.csv("data/clean/LNU_speciesCover_FINAL.csv")

str(LNU_cover_final)
LNU_cover_final$num_burn <- as.numeric(LNU_cover_final$num_burn)
LNU_cover_final$TSLF <- as.factor(LNU_cover_final$TSLF)
LNU_cover_final$mCC_FRI <- as.factor(LNU_cover_final$mCC_FRI)
LNU_cover_final$aspect_name <- as.factor(LNU_cover_final$aspect_name)
LNU_cover_final$year <- as.factor(LNU_cover_final$year)
LNU_cover_final$elevation <- as.numeric(LNU_cover_final$elevation)
LNU_cover_final$crrnFRI <- as.factor(LNU_cover_final$crrnFRI)
LNU_cover_final$cool_warm_slope <- as.factor(LNU_cover_final$cool_warm_slope)
LNU_cover_final$Geology <- as.factor(LNU_cover_final$Geology)

unique(LNU_cover_final$native.nonnative.prop)
LNU_cover_prop <- LNU_cover_final %>% 
  filter(native.nonnative.prop == "prop_native_cover") %>% 
   mutate(cover= ifelse(cover == 1, 0.999, cover))

ggplot(LNU_cover_prop, aes(x=num_burn, y=cover))+
  geom_smooth(method="lm")

ggplot(LNU_cover_prop, aes(x=cool_warm_slope, y=cover))+
  geom_point()

hist(LNU_cover_prop$cover)
range(LNU_cover_prop$cover)

plot(LNU_cover_prop$num_burn, LNU_cover_prop$cover)
plot(LNU_cover_prop$TSLF, LNU_cover_prop$cover)
plot(LNU_cover_prop$ppt, LNU_cover_prop$cover)
plot(LNU_cover_prop$tmean, LNU_cover_prop$cover)
plot(LNU_cover_prop$hli, LNU_cover_prop$cover)
plot(LNU_cover_prop$aspect_name, LNU_cover_prop$cover)
plot(LNU_cover_prop$cool_warm_slope, LNU_cover_prop$cover)
plot(LNU_cover_prop$mCC_FRI, LNU_cover_prop$cover)
plot(LNU_cover_prop$num_burn, LNU_cover_prop$TSLF)
plot(LNU_cover_prop$num_burn, LNU_cover_prop$mCC_FRI)
#determine outliers 
min(LNU_cover_prop$cover) #0.008
max(LNU_cover_prop$cover) #.99
mean(LNU_cover_prop$cover) #.45
ggplot(LNU_cover_prop) +
  aes(x = "", y = cover) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()

m.prop.cover.rich <- brm(
  bf(cover ~ 1 + num_burn, 
     phi ~ num_burn),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich, file= "models/nativeCover_feb23.rda")
load("models/nativeCover_feb23.rda")

m.prop.cover.rich_year <- brm(
  bf(cover ~ 1 + year, 
     phi ~ year),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
summary(m.prop.cover.rich_year)

m.prop.cover.rich_ppt <- brm(
  bf(cover ~ 1 + ppt, 
     phi ~ ppt),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
summary(m.prop.cover.rich_ppt)
conditional_effects(m.prop.cover.rich_ppt)

m.prop.cover.rich_tmean <- brm(
  bf(cover ~ 1 + tmean, 
     phi ~ tmean),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
summary(m.prop.cover.rich_tmean)

m.prop.cover.rich_hli <- brm(
  bf(cover ~ 1 + hli, 
     phi ~ hli),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)

m.prop.cover.rich_slope <- brm(
  bf(cover ~ 1 + cool_warm_slope, 
     phi ~ cool_warm_slope),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)

loo(m.prop.cover.rich, m.prop.cover.rich_year, 
    m.prop.cover.rich_hli, 
    m.prop.cover.rich_ppt, 
    m.prop.cover.rich_tmean, 
    m.prop.cover.rich_slope)

tidy(m.prop.cover.rich, effects = "fixed")
summary(m.prop.cover.rich)
plot(m.prop.cover.rich)
pp_check(m.prop.cover.rich)
conditional_effects(m.prop.cover.rich)
bayes_R2(m.prop.cover.rich)


m.prop.cover.rich2 <- brm(
  bf(cover ~ 1 + num_burn * year, 
     phi ~ num_burn * year),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich2, file= "models/nativeCover_feb23_2.rda")
load("models/nativeCover_feb23_2.rda")

m.prop.cover.rich3 <- brm(
  bf(cover ~ 1 + num_burn + year, 
     phi ~ num_burn + year),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich3, file= "models/nativeCover_feb23_3.rda")
load("models/nativeCover_feb23_3.rda")

summary(m.prop.cover.rich3)
loo(m.prop.cover.rich, m.prop.cover.rich3)
conditional_effects(m.prop.cover.rich3)
plot(m.prop.cover.rich3)
mcmc_plot(m.prop.cover.rich3)
pp_check(m.prop.cover.rich3)
bayes_R2(m.prop.cover.rich3)

m.prop.cover.rich4 <- brm(
  bf(cover ~ 1 + num_burn + year + hli + ppt + tmean, 
     phi ~ num_burn + year + hli),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich4, file= "models/nativeCover_feb23_4.rda")
load("models/nativeCover_feb23_4.rda")

summary(m.prop.cover.rich4)
loo(m.prop.cover.rich, m.prop.cover.rich2)
conditional_effects(m.prop.cover.rich4)
bayes_R2(m.prop.cover.rich2)
mcmc_plot(m.prop.cover.rich4)

range(LNU_cover_prop$hli)
nd <- expand_grid(num_burn=unique(LNU_cover_prop$num_burn),
                  year = unique(LNU_cover_prop$year))

beta_bayes_pred <- m.prop.cover.rich%>% 
    epred_draws(newdata = nd)  
    group_by(num_burn, .draw) %>% 
    dplyr::summarise(.epred = mean(.epred))

head(beta_bayes_pred)

ggplot(beta_bayes_pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Reds")+
  labs(x = "Fire frequency", 
       y = "Proportion of native species",
       fill = "Credible interval") +
  theme(legend.position = "bottom")

nd <- expand_grid(num_burn=seq(1,7,by=.01),
                  year = unique(LNU_cover_prop$year))
fitted_prop <- fitted(m.prop.cover.rich,
                 newdata = nd)
head(fitted_prop)
fitted_prop_sum <- fitted_prop %>% 
  as.data.frame() 

fitted_final <- cbind(fitted_prop_sum, nd)
head(fitted_final)
cal <- cal_palette("sierra1", n = 50, type = "continuous")

ggplot(fitted_final, aes(x=num_burn))+
  geom_smooth(aes(y = Estimate, 
                  ymin = Q2.5, ymax = Q97.5),
              stat = "identity", 
              color = "#9999CC",
              alpha = 1/4, size = 1/2)+
  geom_point(aes(y = Estimate),
             size = 2/3,
             color = "#9999CC") +
  labs(x = expression(italic("Fire frequency")),
       y = expression(italic("Proportion of native species"))) +
  scale_fill_gradientn(colours = cal) + 
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())


```

# model richness random forest 

```{r}
library(party)
library(partykit)
library(rpart)
library(rpart.plot)
LNU_cover_final <- read.csv("data/clean/LNU_speciesCover_FINAL.csv")

str(LNU_cover_final)
LNU_cover_final$num_burn <- as.factor(LNU_cover_final$num_burn)
LNU_cover_final$TSLF <- as.factor(LNU_cover_final$TSLF)
LNU_cover_final$mCC_FRI <- as.factor(LNU_cover_final$mCC_FRI)
LNU_cover_final$aspect_name <- as.factor(LNU_cover_final$aspect_name)
LNU_cover_final$year <- as.factor(LNU_cover_final$year)
LNU_cover_final$elevation <- as.numeric(LNU_cover_final$elevation)
LNU_cover_final$crrnFRI <- as.factor(LNU_cover_final$crrnFRI)
LNU_cover_final$cool_warm_slope <- as.factor(LNU_cover_final$cool_warm_slope)
LNU_cover_final$Geology <- as.factor(LNU_cover_final$Geology)
str(LNU_cover_final)

LNU_cover_small <- LNU_cover_final %>% 
  filter(native.nonnative.prop == "prop_native_cover") %>% 
  filter(num_burn != "7") %>% 
  dplyr::select(cover, num_burn, TSLF, hli, cool_warm_slope, 
         ppt, tmean, Geology, Distance_km)

#run random forest model

ctree <- ctree(cover ~ num_burn ,
                data = LNU_cover_small)
plot(ctree)

ctree1 <- ctree(cover ~ num_burn + TSLF +
                  hli + cool_warm_slope + ppt +tmean,
                    data = LNU_cover_small,
                control = ctree_control(testtype = "Bonferroni"))

dev.off()
print(ctree1)
plot(ctree1)

varimp(ctree1)
varimp(ctree1, conditional = TRUE)

```



# Seedling Density Regression

use bernoulli prior and constrain the priors

prior1 <- prior("normal(0,1)", class = "b") +
  prior("student_t(3, 0, 1)", class = "sds", coef = "s(transect_dist_m, by = Plot)")
  # only 1 coef for this. t(3,0,1) is aki vehtarhi's favorite weakly informative prior.
  I changed this from t(3, 0, 2.5)


when no prior used, model cannot be fit, rhat ~1.04 and very low estimated sample size. This is probably because one or more of the predictors causes full separation of the outcome. See page 256 of Regression and other stories for more information.


```{r Seedling Density }


#####DENSITY

shrub_seedling_data <- read.csv("data/clean/shrub_seedling_data_ALL.csv")

seedling_data <- left_join(shrub_seedling_data, plot.description_LNU, by="PlotID")
seedling_data <- left_join(seedling_data, species.short, by ="spp")

#check data
seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  ggplot(aes(x=num_burn, y=avg.count, color=spp))+
  geom_smooth(method = "lm")+
  geom_point()+
  geom_jitter()+
  facet_wrap(~fac.obl)

seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  ggplot(aes(x=num_burn, y=prop.presence, color=spp))+
   geom_smooth(method = "lm")+
  geom_point()+
  geom_jitter()+
  facet_wrap(~fac.obl)

#check numbe of 0s
100*sum(shrub_density_long$density == 0)/nrow(shrub_density_long)

##Visualize data
str(seedling_data)
#shrub_density_total$num_burn <- as.factor(shrub_density_total$num_burn)

shrub_density_sum <- seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  group_by(num_burn, fac.obl) %>% 
  dplyr::summarise(mean_den = mean(avg.count),
            max_den = max(avg.count),
            min_den = min(avg.count),
            n_obs = n(),
            sd = sd(avg.count),
            se= sd/sqrt(n_obs))

ggplot(shrub_density_sum, 
       aes(x=as.factor(num_burn), y=mean_den, fill=as.factor(num_burn)))+
  geom_bar(stat = "identity", position = position_dodge())+
  geom_errorbar(aes(ymax=mean_den + se, ymin=mean_den-se), width=.2,
                position=position_dodge(.9))+
  facet_wrap(~fac.obl, scales = "free")

hist(seedling_data$avg.count)
hist(seedling_data$prop.presence)
mean(seedling_data$avg.count). #.101
mean(seedling_data$prop.presence). #.022
sd(seedling_data$avg.count) #.768
sd(seedling_data$prop.presence) #.099

#look at OBL-S only
str(shrub_density_OBLS)
range(shrub_density_OBLS$prop.presence)

shrub_density_OBLS <- seedling_data %>%
  filter(fac.obl == "OBL-S") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))

shrub_density_OBLS$year <- as.factor(shrub_density_OBLS$year)
shrub_density_FAC$year <- as.factor(shrub_density_FAC$year)

plot(shrub_density_OBLS$num_burn, shrub_density_OBLS$presence)
plot(shrub_density_OBLS$TSLF, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$hli, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$ppt, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$tmean, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$elevation, shrub_density_OBLS$prop.presence)

shrub_density_OBLS %>% 
  dplyr::count(prop.presence == 0) %>% 
  mutate(prop = n/sum(n)) 

cor(shrub_density_OBLS[,c("num_burn","TSLF",
                          "hli","slope",
                          "ppt","tmean","elevation")])
pairs(shrub_density_OBLS[,c("num_burn","TSLF",
                          "hli","slope",
                          "ppt","tmean","elevation")])

ggplot(shrub_density_OBLS, aes(x=num_burn, y=presence,
                               color=spp))+
  geom_point()+
  geom_jitter()

ggplot(shrub_density_FAC, aes(x=num_burn, y=presence,
                               color=spp))+
  geom_point()+
  geom_jitter()


priors <- c(set_prior("normal(0,1)", class = "b"),
            set_prior("student_t(3, 0, 1)", class = "Intercept"))
  # only 1 coef for this. t(3,0,1) is aki vehtarhi's favorite weakly informative prior.
 # I changed this from t(3, 0, 2.5)
prior_summary(m.shrubDensityOBL)
m.shrubDensityOBL <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL, file = "models/shrubDensityOBL.rda")
load("models/shrubDensityOBL.rda")

tidy(m.shrubDensityOBL, effects = "fixed")
summary(m.shrubDensityOBL)
conditional_effects(m.shrubDensityOBL)
plot(m.shrubDensityOBL)
pp_check(m.shrubDensityOBL)
bayes_R2(m.shrubDensityOBL)

pred <- m.shrubDensityOBL %>% 
  epred_draws(newdata = expand_grid(num_burn=seq(1,7,by=.1)))
pred

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of obligate seeder",
       fill = "Credible interval") +
  theme(legend.position = "bottom")

m.shrubDensityOBL2 <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn * year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL2, file = "models/shrubDensityOBL2.rda")
load("models/shrubDensityOBL2.rda")

summary(m.shrubDensityOBL2b)
conditional_effects(m.shrubDensityOBL2b)
plot(m.shrubDensityOBL2)
pp_check(m.shrubDensityOBL2)
bayes_R2(m.shrubDensityOBL2)
loo(m.shrubDensityOBL,m.shrubDensityOBL2)


m.shrubDensityOBL2b <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL2b, file = "models/shrubDensityOBL2b.rda")
load("models/shrubDensityOBL2b.rda")

m.shrubDensityOBL3 <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn + year + hli,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL3, file = "models/shrubDensityOBL3.rda")
load("models/shrubDensityOBL3.rda")

summary(m.shrubDensityOBL3)
conditional_effects(m.shrubDensityOBL3)
plot(m.shrubDensityOBL3)
pp_check(m.shrubDensityOBL3)
bayes_R2(m.shrubDensityOBL3)
loo(m.shrubDensityOBL, m.shrubDensityOBL2b, m.shrubDensityOBL3)

nd <- expand_grid(num_burn=seq(1,7,by=.1),
                  year=unique(shrub_density_OBLS$year))

pred <- m.shrubDensityOBL2b%>% 
    epred_draws(newdata = nd)

head(pred)





####### Facultative
shrub_density_FAC <- seedling_data %>%
  filter(fac.obl == "FAC") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence)) 

unique(shrub_density_FAC$spp)
shrub_density_FAC$year <- as.factor(shrub_density_FAC$year)

m.shrubDensityFAC <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC, file = "models/shrubDensityFAC.rda")
load("models/shrubDensityFAC.rda")

tidy(m.shrubDensityFAC, effects = "fixed")
summary(m.shrubDensityFAC)
conditional_effects(m.shrubDensityFAC)
plot(m.shrubDensityFAC)
pp_check(m.shrubDensityFAC)
bayes_R2(m.shrubDensityFAC)

pred <- m.shrubDensityFAC %>% 
  epred_draws(newdata = expand_grid(num_burn=seq(1,7,by=.1)))
pred

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of facultative seeder",
       fill = "Credible interval") +
  theme(legend.position = "bottom")

m.shrubDensityFAC2 <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC2, file = "models/shrubDensityFAC2.rda")
load("models/shrubDensityFAC2.rda")

summary(m.shrubDensityFAC2)
conditional_effects(m.shrubDensityFAC2)
plot(m.shrubDensityFAC2)
pp_check(m.shrubDensityFAC2)
bayes_R2(m.shrubDensityFAC2)
loo(m.shrubDensityFAC,m.shrubDensityFAC2)

m.shrubDensityFAC3 <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn + year + hli,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC3, file = "models/shrubDensityFAC3.rda")
load("models/shrubDensityFAC3.rda")

summary(m.shrubDensityFAC3)
conditional_effects(m.shrubDensityFAC3)
plot(m.shrubDensityFAC3)
pp_check(m.shrubDensityFAC3)
bayes_R2(m.shrubDensityFAC3)
loo(m.shrubDensityFAC,m.shrubDensityFAC2, m.shrubDensityFAC3)

nd <- expand_grid(num_burn=seq(1,7,by=.1),
                  year=unique(shrub_density_OBLS$year))

pred <- m.shrubDensityFAC%>% 
    epred_draws(newdata = nd)

head(pred)

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of facultative seeder",
       fill = "Credible interval") +
  theme(legend.position = "bottom")

#ADFA ONLY
shrub_density_ADFA <- seedling_data %>%
  filter(spp == "ADFA") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_3top$year <- as.factor(shrub_density_3top$year)


m.shrubDensityADFA <- brm(data = shrub_density_ADFA,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityADFA, file = "models/shrubDensityADFA.rda")
load("models/shrubDensityADFA.rda")

summary(m.shrubDensityADFA)
conditional_effects(m.shrubDensityADFA)

unique(seedling_data$spp)
shrub_density_ERICAL <- seedling_data %>%
  filter(spp == "ERICAL") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_ERICAL$year <- as.factor(shrub_density_ERICAL$year)

plot(shrub_density_ERICAL$presence, shrub_density_ERICAL$num_burn)

m.shrubDensityERCAL <- brm(data = shrub_density_ERICAL,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityERCAL, file = "models/shrubDensityERCAL.rda")
load("models/shrubDensityERCAL.rda")

summary(m.shrubDensityERCAL)
conditional_effects(m.shrubDensityERCAL)

shrub_density_LEPCAL <- seedling_data %>%
  filter(spp == "LEPCAL") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_LEPCAL$year <- as.factor(shrub_density_LEPCAL$year)


m.shrubDensityLEPCAL <- brm(data = shrub_density_LEPCAL,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityLEPCAL, file = "models/shrubDensityLEPCAL.rda")
load("models/shrubDensityLEPCAL.rda")
summary(m.shrubDensityLEPCAL)
conditional_effects(m.shrubDensityLEPCAL)

nd <- expand_grid(num_burn=seq(1,7,by=.1),
                  year=unique(shrub_density_OBLS$year))

pred <- m.shrubDensityFAC%>% 
    epred_draws(newdata = nd)
pred_adfa <- m.shrubDensityADFA%>% 
    epred_draws(newdata = nd) %>% 
  mutate(spp = "ADFA")
pred_ercal <- m.shrubDensityERCAL%>% 
    epred_draws(newdata = nd) %>% 
  mutate(spp = "ERCAL") 
pred_lepcal <- m.shrubDensityLEPCAL%>% 
    epred_draws(newdata = nd) %>% 
  mutate(spp = "LEPCAL")

pred_all <- rbind(pred_adfa, pred_ercal, pred_lepcal)

ggplot(pred_all, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  facet_grid(. ~ spp, space = "free_x", scales = "free_x")
  labs(x = "Fire frequency", 
       y = "Predicted presence of facultative seeder",
       fill = "Credible interval") +
  theme(legend.position = "bottom")

```


# RANDOM FOREST - SHRUB DENSITY

```{r RF shrub den}

library(party)
library(partykit)
library(rpart)
library(rpart.plot)

shrub_seedling_data <- read.csv("data/clean/shrub_seedling_data_ALL.csv")

seedling_data <- left_join(shrub_seedling_data, plot.description_LNU, by="PlotID")
seedling_data <- left_join(seedling_data, species.short, by ="spp")

str(LNU_cover_final)
seedling_data$num_burn <- as.factor(seedling_data$num_burn)
seedling_data$TSLF <- as.factor(seedling_data$TSLF)
seedling_data$mCC_FRI <- as.factor(seedling_data$mCC_FRI)
seedling_data$aspect_name <- as.factor(seedling_data$aspect_name)
seedling_data$year <- as.factor(seedling_data$year)
seedling_data$elevation <- as.numeric(seedling_data$elevation)
seedling_data$crrnFRI <- as.factor(seedling_data$crrnFRI)
seedling_data$cool_warm_slope <- as.factor(seedling_data$cool_warm_slope)
seedling_data$Geology <- as.factor(seedling_data$Geology)
str(seedling_data)

shrub_density_OBLS <- seedling_data %>%
  filter(fac.obl == "OBL-S") %>% 
  filter(num_burn != "7") %>% 
  dplyr::select(prop.presence, num_burn, TSLF, hli, cool_warm_slope, 
         ppt, tmean, Geology, Distance_km)

#run random forest model

ctree <- ctree(prop.presence ~ num_burn ,
                data = shrub_density_OBLS)
plot(ctree)

ctree1 <- ctree(prop.presence ~ num_burn + 
                  hli + cool_warm_slope + ppt +tmean,
                    data = shrub_density_OBLS,
                control = ctree_control(testtype = "Bonferroni"))

dev.off()
print(ctree1)
plot(ctree1)

varimp(ctree1)
varimp(ctree1, conditional = TRUE)



```


