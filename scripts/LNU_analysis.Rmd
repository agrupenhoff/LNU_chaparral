---
title: "LNU Analysis"
author: "Ashley Grupenhoff"
date: "5/6/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/ashle/OneDrive/Documents/R/LNU_chaparral/LNU_chaparral")
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(plyr)
library(brms)
library(rstan)
library(tidybayes)
library(bayesplot)
library(bayestestR)
library(emmeans)
library(calecopal)
library(modelr)
library(brmsmargins)
library(ROCR) #calculate area under curve
library(stringr) #str_detect
library(forcats) #fct_rev

library(broom)            # Convert model objects to data frames
library(broom.mixed)   

#run faster
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

```

## Input clean data
```{r data}
#raw
TOT_species_LNU <- read.csv("data/raw/TOT_species_LNU.csv")
subplot_species_LNU <- read.csv("data/raw/SubPlot_SPP_LNU.csv")
severity_LNU <- read.csv("data/raw/Severity_LNU.csv")
GroundCover_LNU <- read.csv("data/raw/GroundCover_LNU.csv")
Mortality_LNU <- read.csv("data/raw/Mortality_LNU.csv")

plot.description_LNU <- read.csv("data/clean/LNU_plot_description_CLEAN.csv")
SpeciesList <- read.csv("data/raw/SpeciesList_jan23.csv")

species.short <- SpeciesList %>% 
  dplyr::select(spp, Lifeform, Native_nonnative, fac.obl) 


plyr::count(plot.description_LNU$cool_warm_slope)

```


## Severity 

```{r severity}


severity_LNU_clean <- severity_LNU %>% 
  group_by(PlotID, year) %>% 
  dplyr::summarise(mean_diam_mm = mean(Mean_diam),
            sd = sd(Mean_diam),
            n_obs = n(),
            se = sd/sqrt(n_obs),
            max_diam_mm = max(Mean_diam))

severity.plotdescription.LNU <- left_join(severity_LNU_clean, 
                                          plot.description_LNU, by="PlotID")


sevdata <- ddply(severity.plotdescription.LNU, c("num_burn"),
                 summarise,
                 N = sum(!is.na(mean_diam_mm)),
                 mean_diam_mm_avg = mean(mean_diam_mm, na.rm=TRUE),
                 sd= sd(mean_diam_mm, na.rm = TRUE),
                 se = sd/sqrt(N),
                 cv = 100*sd/mean_diam_mm_avg,
                 
                 max = mean(max_diam_mm, na.rm = TRUE),
                 sd_max = sd(max_diam_mm, na.rm = TRUE),
                 se_max = sd_max/sqrt(N),
                 cv_max = 100*sd_max/max
                 ) 


ggplot(data=sevdata %>%  
         filter(num_burn != "2"), 
       aes(x=as.factor(num_burn), y=mean_diam_mm_avg))+
  geom_bar(stat = "identity", aes(fill= as.factor(num_burn)))+
  geom_errorbar(aes(ymin=mean_diam_mm_avg-se, ymax=mean_diam_mm_avg+se), width=.1, size=.7)+
  #geom_point(size=3, aes(colour=factor(num_burn)))+
  scale_fill_manual(values = cal_palette("sierra1")) +
                     xlab("Fire frequency")+
                     ylab("Fire Severity (mm)")+
                    theme_bw()+
                   theme(legend.title = element_blank(),
                           axis.text = element_text(size=15),
                            text = element_text(size = 16),
                          panel.grid = element_blank())
ggsave(file="figures/sev~freq.svg", width = 4.5, height = 3)
ggsave(file="figures/sev~freq.png", width = 4.5, height = 3)





#LINEAR MODEL
qqnorm(severity.plotdescription.LNU$mean_diam_mm, pch = 1, frame = FALSE)
qqline(severity.plotdescription.LNU$mean_diam_mm, col = "steelblue", lwd = 2)

m.sev <- lm(num_burn ~ mean_diam_mm ,
                 data = severity.plotdescription.LNU, REML = F)
summary(m.sev)
coef(summary(m.nativeRich))
plot(m.sev)

```

# Ground cover data

```{r}

str(GroundCover_LNU)
GroundCover_LNU$Litter_depth_cm <- as.numeric(GroundCover_LNU$Litter_depth_cm)
GroundCover_LNU$SH_ht_cm <- as.numeric(GroundCover_LNU$SH_ht_cm)
GroundCover_LNU$year <- as.factor(GroundCover_LNU$year)

groundcover_LNU <- left_join(GroundCover_LNU, 
                              plot.description_LNU, by="PlotID")

groundcover_LNU_clean <- groundcover_LNU %>% 
  select(PlotID, year, num_burn, rock_percent, BG_percent, litter_percent,
         Litter_depth_cm, SH_cover_percent, SH_ht_cm, HB_cover_percent) %>% 
  group_by(num_burn, year) %>% 
  dplyr::summarise_if(is.numeric, 
                      funs(mean(., na.rm=T), 
                           n = sum(!is.na(.)), 
                           se = sd(., na.rm=T)/sqrt(sum(!is.na(.))))) 
  
ggplot(data=groundcover_LNU_clean,
       aes(x=num_burn, y=HB_cover_percent_mean))+
  geom_bar(stat = "identity", aes(fill= as.factor(num_burn)))+
  #geom_errorbar(aes(ymin=litter_percent_mean - litter_percent_se, 
  #                  ymax=litter_percent_mean + litter_percent_se), 
  #                width=.1, linewidth=.7)+
  facet_wrap(~year)+
  #geom_point(size=3, aes(colour=factor(num_burn)))+
  scale_fill_manual(values = cal_palette("sierra1")) +
  #                   xlab("Fire frequency")+
  #                   ylab("Rock  %")+
             
                   theme(legend.title = element_blank(),
                           axis.text = element_text(size=15),
                            text = element_text(size = 16),
                          panel.grid = element_blank())


```


# NMDS

Updated april 17, 2023

```{r}
library(vegan)

LNU_combine_wide <- read.csv("data/clean/LNU_species_all_wide.csv")

#make community matrix on which to base ordination
LNUspecies = LNU_combine_wide %>% select(!c("plot_year","X")) 

#columns that contain descriptive data
LNUplot_ord = LNU_combine_wide %>% 
  select(plot_year) %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

plot.description.short <- plot.description_LNU %>% 
  select(PlotID, num_burn, ppt, tmean, hli, cool_warm_slope, TSLF)

LNUplot_env <- left_join(LNUplot_ord, plot.description.short %>% distinct(), by = "PlotID")

set.seed(123) #reproduce same results
NMDS <- metaMDS(LNUspecies, distance="bray", k=3) #no transformation of species data is made here prior to bray curtis dissimilarities being calculated. 
NMDS

LNU.envfit <- envfit(NMDS, LNUplot_env, permutations = 999) # this fits environmental vectors


#env.fit
nmds_plot <- cbind(NMDS$point, LNUplot_env)
nmds_species <- cbind(as.data.frame(NMDS$species), 
                      as.data.frame(row.names(as.data.frame(NMDS$species)))) %>% 
                       dplyr::rename(spp = "row.names(as.data.frame(NMDS$species))")
nmds_species <- left_join(nmds_species, species.short, by = "spp")
nmds_plot$num_burn <- as.factor(nmds_plot$num_burn)


#significant species 
LNU.spp.fit <- envfit(NMDS, LNUspecies, permutations = 999 )
spp.scrs <- as.data.frame(scores(LNU.spp.fit, display = "vectors")) 
          #save species intrinsic values into dataframe
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs)) 
          #add species names to dataframe
spp.scrs <- cbind(spp.scrs, pval = LNU.spp.fit$vectors$pvals) 
            #add pvalues to dataframe so you can select species which are significant
sig.spp.scrs <- subset(spp.scrs, pval<=0.05) #subset data to show species significant at 0.05

head(spp.scrs)


ggplot(nmds_plot, aes(x=MDS1, y=MDS2))+
 geom_point(size = 4, aes(x=MDS1, y=MDS2, color = num_burn))+
  geom_segment(data = sig.spp.scrs, 
               aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), 
               colour = "grey10", lwd=0.3) +
  #add vector arrows of significant species
   ggrepel::geom_text_repel(data = sig.spp.scrs, 
                            aes(x=NMDS1, y=NMDS2, label = Species), 
                            cex = 3, direction = "both", segment.size = 0.25)+ 
  #add labels for species, use ggrepel::geom_text_repel so that labels do not overlap
  #geom_point(data= nmds_species, size = 1.8, alpha = 0.5, aes(x=MDS1, y=MDS2, 
  #                                               shape = Native_nonnative))+
  stat_ellipse(aes(x=MDS1, y=MDS2, color = num_burn))+
  scale_color_viridis_d(option = "magma")+
  guides(col=guide_legend("Fire Frequency"))+
  theme(axis.text = element_text(size=15),
        text = element_text(size = 16),
        panel.grid = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size=11))

ggsave(file="figures/NMDS.svg", width = 10, height = 6)
ggsave(file="figures/NMDS.png", width = 10, height = 6)



```



# prepare Richness file

Calculated richness by each sub plot probably want to do this by total plot?

```{r Richness, echo=FALSE}
#calculate richness

LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")

#sum up the number of non-zero entries per row 
#first column ignored ([,-1]) since this is the site name, not species count
LNU_richness_nonnative <- ddply(LNU_sub_nonnative_wide,~plot_yr_quad,function(x) {
  data.frame(NONNATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness_native <- ddply(LNU_sub_native_wide,~plot_yr_quad,function(x) {
  data.frame(NATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness <- left_join(LNU_richness_native, LNU_richness_nonnative, by="plot_yr_quad")

LNU_richness_proportion_5m2 <- LNU_richness %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  mutate(prop.native = (NATIVE_RICHNESS/(NATIVE_RICHNESS + NONNATIVE_RICHNESS))) %>% 
  separate(plot_yr_quad, c("plot_year", "quad"), sep=" ") %>% 
  group_by(plot_year) %>% 
  dplyr::summarise(mean_native_rich = mean(NATIVE_RICHNESS),
            mean_nonnative_rich = mean(NONNATIVE_RICHNESS),
            mean_propNative = mean(prop.native),
            sum_native_rich = sum(NATIVE_RICHNESS),
            sum_nonnative_rich = sum(NONNATIVE_RICHNESS),
            sum_propNative = sum(prop.native)) %>% 
  pivot_longer(!plot_year,
               names_to = "native.nonnative.prop",
               values_to = "richness") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

LNU_richness_proportion_1m2 <- LNU_richness %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  mutate(prop.native = (NATIVE_RICHNESS/(NATIVE_RICHNESS + NONNATIVE_RICHNESS))) %>% 
  pivot_longer(!plot_yr_quad,
               names_to = "native.nonnative.prop",
               values_to = "richness") %>% 
    separate(plot_yr_quad, c("plot_year", "quad"), sep=" ") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

LNU_richness_final_5m2 <- left_join(LNU_richness_proportion_5m2, plot.description_LNU, by="PlotID")
LNU_richness_final_1m2 <- left_join(LNU_richness_proportion_1m2, plot.description_LNU, by="PlotID")


write.csv(LNU_richness_final_5m2, "data/clean/LNU_subplot_RICHNESS_5m2.csv")
write.csv(LNU_richness_final_1m2, "data/clean/LNU_subplot_RICHNESS_1m2.csv")
            
```

#prepare total cover file (proportion)

```{r}
LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")
str(LNU_sub_nonnative_wide)

LNU_nonnative <- LNU_sub_nonnative_wide %>% 
    dplyr::select(!(X)) %>% 
    dplyr::mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   dplyr::select(plot_yr_quad, sum) %>% 
    dplyr::rename(nonnative_cover = sum)

LNU_native <- LNU_sub_native_wide %>% 
    dplyr::select(!(X)) %>% 
    dplyr::mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   dplyr::select(plot_yr_quad, sum) %>% 
    dplyr::rename(native_cover = sum)

LNU_cover <- left_join(LNU_native, LNU_nonnative, by="plot_yr_quad")
head(LNU_cover)

LNU_cover_clean <- LNU_cover %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  separate(plot_yr_quad, c("plot_year", "quad"), sep=" ") %>% 
  group_by(plot_year) %>% 
  dplyr::summarise(mean_native_cover= mean(native_cover),
                   mean_nonnative_cover = mean(nonnative_cover),
                   sum_native_cover = sum(native_cover),
                   sum_nonnative_cover = sum(nonnative_cover)) %>% 
   mutate(prop_native_cover = (mean_native_cover/
                                 (mean_native_cover + mean_nonnative_cover))) %>% 
   pivot_longer(!plot_year,
               names_to = "native.nonnative.prop",
               values_to = "cover") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 


LNU_cover_final <- left_join(LNU_cover_clean, plot.description_LNU, by="PlotID")

write.csv(LNU_cover_final, "data/clean/LNU_speciesCover_FINAL.csv")

str(LNU_cover_final)
LNU_cover_final$num_burn <- as.factor(LNU_cover_final$num_burn)

LNU_cover_final %>% 
  filter(native.nonnative.prop == "prop_native_cover" &
          PFR == "chaparral and serotinous conifer") %>% 
  ggplot(aes(x= num_burn, y = cover))+
  geom_boxplot()





```


# model richness regression 5m2 

For mean of all 5 1m2 quads per plot. 

Step 1: run model with each potential predictor variable separately 
Model comparisons:
                        elpd
year   32.9
num Burn  23.9
cool warm slope 22.3
hli   19.8
        HLI values range from 0 (coolest) to 1 (hottest).
ppt   18
tmean 4.6

Calculated elpd - the expected log pointwise predictive density to figure out which predictors to add

BEST MODEL =
m.propnatRich3 <- brm(
  bf(prop_native_rich ~ 1 + num_burn + year + cool_warm_slope, 
     phi ~ num_burn + year + cool_warm_slope))

```{r regression RICH}


LNU_richness_5m2 <- read.csv("data/clean/LNU_subplot_RICHNESS_5m2.csv")
LNU_richness_1m2 <- read.csv("data/clean/LNU_subplot_RICHNESS_1m2.csv")

propnativeRich_1m2 <- LNU_richness_1m2 %>% 
  filter(native.nonnative.prop == "prop.native")  %>% 
  filter(PFR != "oak woodland") %>% 
  dplyr::rename(prop_native_rich = richness)

propnativeRich_5m2 <- LNU_richness_5m2 %>% 
  filter(native.nonnative.prop == "mean_propNative")  %>% 
  filter(PFR != "oak woodland") %>% 
  dplyr::rename(prop_native_rich = richness)

str(propnativeRich)
propnativeRich_1m2$num_burn <- as.numeric(propnativeRich_1m2$num_burn)
propnativeRich_5m2$num_burn <- as.numeric(propnativeRich_5m2$num_burn)
propnativeRich_1m2$year <- as.factor(propnativeRich_1m2$year)
propnativeRich_5m2$year <- as.factor(propnativeRich_5m2$year)
propnativeRich_1m2$elevation <- as.numeric(propnativeRich_1m2$elevation)
propnativeRich_5m2$elevation <- as.numeric(propnativeRich_5m2$elevation)
propnativeRich_1m2$cool_warm_slope <- as.factor(propnativeRich_1m2$cool_warm_slope)
propnativeRich_5m2$cool_warm_slope <- as.factor(propnativeRich_5m2$cool_warm_slope)


##BAYESIAN
#repeated measures looking at richness based on different fire frequencies 

ggplot(propnativeRich_1m2, 
       aes(x=num_burn, y=prop_native_rich,
                           color = cool_warm_slope))+
  geom_point()

ggplot(propnativeRich_5m2, 
       aes(x=num_burn, y=prop_native_rich,
                           color = cool_warm_slope))+
  geom_point()


propnativeRich_small_1m2 <- propnativeRich_1m2 %>% 
  dplyr::select(prop_native_rich, year, Site, num_burn, mCC_FRI, TSLF,
         ppt, tmean, elevation, slope, Distance_km, hli,
         Geology, aspect_name, cool_warm_slope) %>% 
  #can't have exactly 0 or 1
  mutate(prop_native_rich = ifelse(prop_native_rich == 1, 0.999, prop_native_rich))

propnativeRich_small_5m2 <- propnativeRich_5m2 %>% 
  dplyr::select(prop_native_rich, year, Site, num_burn, mCC_FRI, TSLF,
         ppt, tmean, elevation, slope, Distance_km, hli,
         Geology, aspect_name, cool_warm_slope) %>% 
  #can't have exactly 0 or 1
  mutate(prop_native_rich = ifelse(prop_native_rich == 1, 0.999, prop_native_rich))


range(propnativeRich_small_1m2$prop_native_rich)
#check if covariates are correlated
hist(propnativeRich_1m2$prop_native_rich)
str(propnativeRich_small_1m2)
data_1m2 <- propnativeRich_small_1m2[ , c("ppt", "tmean", "elevation", "slope", "hli")]
cor(data_1m2) #this looks good!!

hist(propnativeRich_small_5m2$prop_native_rich)
str(propnativeRich_small_5m2)
data_5m2 <- propnativeRich_small_5m2[ , c("ppt", "tmean", "elevation", "slope", "hli")]
cor(data_5m2) #this looks good!!


######## run model with each predictor variable seperately 
m.propnatRich <- brm(
  bf(prop_native_rich ~ 1 + num_burn, 
     phi ~ num_burn),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich, file= "models/nativeRich_numburn_5m2.rda")
load("models/nativeRich_numburn_5m2.rda")
summary(m.propnatRich)

m.propnatRich_year <- brm(
  bf(prop_native_rich ~ 1 + year, 
     phi ~ year),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich_year, file= "models/nativeRich_year_5m2.rda")
load("models/nativeRich_year_5m2.rda")

m.propnatRich_ppt <- brm(
  bf(prop_native_rich ~ 1 + ppt, 
     phi ~ ppt),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich_ppt, file= "models/nativeRich_ppt_5m2.rda")
load("models/nativeRich_ppt_5m2.rda")

m.propnatRich_tmean <- brm(
  bf(prop_native_rich ~ 1 + tmean, 
     phi ~ tmean),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich_tmean, file= "models/nativeRich_tmean_5m2.rda")
load("models/nativeRich_tmean_5m2.rda")

m.propnatRich_hli <- brm(
  bf(prop_native_rich ~ 1 + hli, 
     phi ~ hli),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich_hli, file= "models/nativeRich_hli_5m2.rda")
load("models/nativeRich_hli_5m2.rda")

m.propnatRich_coolwarmslope <- brm(
  bf(prop_native_rich ~ 1 + cool_warm_slope, 
     phi ~ cool_warm_slope),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich_coolwarmslope, file= "models/nativeRich_coolwarmslope_5m2.rda")
load("models/nativeRich_coolwarmslope_5m2.rda")


loo(m.propnatRich, 
    m.propnatRich_hli,
    m.propnatRich_ppt,
    m.propnatRich_tmean,
    m.propnatRich_year,
        m.propnatRich_coolwarmslope)

tidy(m.propnatRich, effects = "fixed")
summary(m.propnatRich)
conditional_effects(m.propnatRich)
bayes_R2(m.propnatRich)
plot(m.propnatRich)
pp_check(m.propnatRich)

str(propnativeRich_small_5m2)

m.propnatRich2 <- brm(
  bf(prop_native_rich ~ 1 + num_burn + year, 
     phi ~ num_burn + year),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich2, file = "models/nativeRich2_5m2.rda")
load("models/nativeRich2_5m2.rda")

loo(m.propnatRich_year, m.propnatRich2)
summary(m.propnatRich2)
conditional_effects(m.propnatRich2)
pp_check(m.propnatRich2)
plot(m.propnatRich2)
bayes_R2(m.propnatRich2)


m.propnatRich3 <- brm(
  bf(prop_native_rich ~ 1 + num_burn + year + cool_warm_slope, 
     phi ~ num_burn + year + cool_warm_slope),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich3, file = "models/nativeRich3_5m2.rda")
load("models/nativeRich3_5m2.rda")

m.propnatRich4 <- brm(
  bf(prop_native_rich ~ 1 + num_burn + year + cool_warm_slope + hli, 
     phi ~ num_burn + year + cool_warm_slope + hli),
  data = propnativeRich_small_5m2,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.propnatRich4, file = "models/nativeRich4_5m2.rda")
load("models/nativeRich4_5m2.rda")

loo(m.propnatRich,m.propnatRich2,  m.propnatRich3, m.propnatRich4)


loo(m.propnatRich, m.propnatRich2, m.propnatRich3)
summary(m.propnatRich3)
conditional_effects(m.propnatRich3)
bayes_R2(m.propnatRich3)
pp_check(m.propnatRich3)
mcmc_intervals(m.propnatRich)

#CREATE FIGURE

nd <- propnativeRich_5m2 %>% 
 data_grid(num_burn=seq(1,7,by=.01),
            year=c(2021, 2022),
            cool_warm_slope = c("cool","warm"))

prop.rich.5m2.fitted <- 
    fitted(m.propnatRich3, 
           newdata= nd) %>% 
    as.data.frame() %>% 
    cbind(nd)


  ggplot(prop.rich.5m2.fitted, aes(x=num_burn))+
      geom_smooth(aes(y = Estimate, 
                     ymin = Q2.5, ymax = Q97.5,
                    fill = cool_warm_slope, 
                    color = cool_warm_slope),
                      stat = "identity", 
                      alpha = 1/4, size = 1/2)+
          geom_point(aes(y = Estimate, color = cool_warm_slope),
                     size = 2/3)+
    #geom_point(data=propnativeRich_small_5m2 , alpha=.2)+
     #geom_jitter(data=propnativeRich_small_5m2, alpha =.2)+
    facet_wrap(~year)+
     labs(x="Fire Frequency", y= "Proportion Native richness",
       fill="credible interval")+
     scale_color_manual(values = cal_palette("gayophytum")) +
  scale_fill_manual(values = cal_palette("gayophytum")) +
  theme(legend.position = "bottom")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank())

plot

propnativeRich_5m2 %>% 
  data_grid(num_burn=seq(1,7,by=.1),
            year=c(2021, 2022),
            cool_warm_slope = c("cool","warm")) %>% 
  add_draws(posterior_epred(m.propnatRich3, newdata= .)) %>% 
  ggplot(aes(x=num_burn, y=prop_native_rich))+
  stat_lineribbon(aes(y=.value),alpha=.35,.width = c(.66, .95))+
  geom_point(data=propnativeRich_5m2  , alpha=.2)+
  geom_jitter(data=propnativeRich_5m2 , alpha =.2)+
  facet_wrap(~year)+
  labs(x="Fire Frequency", y= "Proportion Native Richness",
       fill="credible interval")+
  theme(legend.position = "bottom")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank())

```

# model p(cover) brms - COMPLETE 

final model beta binomial p(native cover) ~ 1 + num_burn + year 
phi ~ 1+num_burn + year

Step 1: run model with each potential predictor variable separately 
Model comparisons:
                        elpd
m.prop.cover.rich_num Burn  22.2
m.prop.cover.rich_year   9.3
m.prop.cover.rich_hli   10
HLI values range from 0 (coolest) to 1 (hottest).
m.prop.cover.rich_ppt   9.6
m.prop.cover.rich_tmean 6.2
m.prop.cover.rich_slope 5.8

Calculated elpd - the expected log pointwise predictive density to figure out which predictors to add


```{r}
LNU_cover_final <- read.csv("data/clean/LNU_speciesCover_FINAL.csv")

str(LNU_cover_final)
LNU_cover_final$num_burn <- as.numeric(LNU_cover_final$num_burn)
LNU_cover_final$TSLF <- as.factor(LNU_cover_final$TSLF)
LNU_cover_final$mCC_FRI <- as.factor(LNU_cover_final$mCC_FRI)
LNU_cover_final$aspect_name <- as.factor(LNU_cover_final$aspect_name)
LNU_cover_final$year <- as.factor(LNU_cover_final$year)
LNU_cover_final$elevation <- as.numeric(LNU_cover_final$elevation)
LNU_cover_final$crrnFRI <- as.factor(LNU_cover_final$crrnFRI)
LNU_cover_final$cool_warm_slope <- as.factor(LNU_cover_final$cool_warm_slope)
LNU_cover_final$Geology <- as.factor(LNU_cover_final$Geology)


#CENTER AND SCALE COVARIATES
LNU_cover_final$ppt.scale <- scale(LNU_cover_final$ppt, center = TRUE, scale = TRUE)
LNU_cover_final$tmean.scale <- scale(LNU_cover_final$tmean, center = TRUE, scale = TRUE)
LNU_cover_final$hli.scale <- scale(LNU_cover_final$hli, center = TRUE, scale = TRUE)
LNU_cover_final$slope.scale <- scale(LNU_cover_final$slope, center = TRUE, scale = TRUE)
LNU_cover_final$elevation.scale <- scale(LNU_cover_final$elevation, center = TRUE, scale = TRUE)

str(LNU_cover_final)

unique(LNU_cover_final$native.nonnative.prop)
LNU_cover_prop <- LNU_cover_final %>% 
  filter(native.nonnative.prop == "prop_native_cover") %>% 
   mutate(cover= ifelse(cover == 1, 0.999, cover))

ggplot(LNU_cover_prop, aes(x=num_burn, y=cover))+
  geom_smooth(method="lm")

ggplot(LNU_cover_prop, aes(x=cool_warm_slope, y=cover))+
  geom_point()

hist(LNU_cover_prop$cover)
range(LNU_cover_prop$cover)

#CENTER AND SCALE DATA


plot(LNU_cover_prop$num_burn, LNU_cover_prop$cover)
plot(LNU_cover_prop$TSLF, LNU_cover_prop$cover)
plot(LNU_cover_prop$ppt.scale, LNU_cover_prop$cover)
plot(LNU_cover_prop$tmean.scale, LNU_cover_prop$cover)
plot(LNU_cover_prop$hli.scale, LNU_cover_prop$cover)
plot(LNU_cover_prop$aspect_name, LNU_cover_prop$cover)
plot(LNU_cover_prop$cool_warm_slope, LNU_cover_prop$cover)
plot(LNU_cover_prop$mCC_FRI, LNU_cover_prop$cover)
plot(LNU_cover_prop$num_burn, LNU_cover_prop$TSLF)
plot(LNU_cover_prop$num_burn, LNU_cover_prop$mCC_FRI)
#determine outliers 
min(LNU_cover_prop$cover) #0.008
max(LNU_cover_prop$cover) #.99
mean(LNU_cover_prop$cover) #.45
ggplot(LNU_cover_prop) +
  aes(x = "", y = cover) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()

#####
######## run model with each predictor variable seperately 

m.prop.cover.rich <- brm(
  bf(cover ~ 1 + num_burn, 
     phi ~ num_burn),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich, file= "models/nativeCover_numburn.rda")
load("models/nativeCover_numburn.rda")

m.prop.cover.rich_year <- brm(
  bf(cover ~ 1 + year, 
     phi ~ year),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
summary(m.prop.cover.rich_year)
save(m.prop.cover.rich_year, file= "models/nativeCover_year.rda")
load("models/nativeCover_year.rda")

m.prop.cover.rich_ppt <- brm(
  bf(cover ~ 1 + ppt, 
     phi ~ ppt),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich_ppt, file= "models/nativeCover_ppt.rda")
load("models/nativeCover_ppt.rda")

m.prop.cover.rich_tmean <- brm(
  bf(cover ~ 1 + tmean, 
     phi ~ tmean),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich_tmean, file= "models/nativeCover_tmean.rda")
load("models/nativeCover_tmean.rda")

m.prop.cover.rich_hli <- brm(
  bf(cover ~ 1 + hli, 
     phi ~ hli),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich_hli, file= "models/nativeCover_hli.rda")
load("models/nativeCover_hli.rda")

m.prop.cover.rich_slope <- brm(
  bf(cover ~ 1 + cool_warm_slope, 
     phi ~ cool_warm_slope),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich_slope, file= "models/nativeCover_slope.rda")
load("models/nativeCover_slope.rda")


loo(m.prop.cover.rich, 
    m.prop.cover.rich_year, 
    m.prop.cover.rich_hli, 
    m.prop.cover.rich_ppt, 
    m.prop.cover.rich_tmean, 
    m.prop.cover.rich_slope)

m.prop.cover.rich2 <- brm(
  bf(cover ~ 1 + num_burn + hli, 
     phi ~ num_burn + hli),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich2, file= "models/nativeCover2.rda")
load("models/nativeCover2.rda")

stancode(m.prop.cover.rich3)
brms::prior_summary(m.prop.cover.rich3)

summary(m.prop.cover.rich2)
loo(m.prop.cover.rich, m.prop.cover.rich2)
plot(conditional_effects(m.prop.cover.rich2, points=T))
plot(m.prop.cover.rich2)
pp_check(m.prop.cover.rich2)
bayes_R2(m.prop.cover.rich2)

m.prop.cover.rich3 <- brm(
  bf(cover ~ 1 + num_burn + year, 
     phi ~ num_burn + year),
  data = LNU_cover_prop,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234)
save(m.prop.cover.rich3, file= "models/nativeCover_3.rda")
load("models/nativeCover_3.rda")

summary(m.prop.cover.rich3)
loo(m.prop.cover.rich, m.prop.cover.rich3)
conditional_effects(m.prop.cover.rich3)
bayes_R2(m.prop.cover.rich3)
mcmc_plot(m.prop.cover.rich3)


LNU_cover_prop %>% 
  data_grid(num_burn=seq(1,7,by=.1),
            year=c(2021, 2022)) %>% 
  add_draws(posterior_epred(m.prop.cover.rich3, newdata= .)) %>% 
  ggplot(aes(x=num_burn, y=cover))+
  stat_lineribbon(aes(y=.value),alpha=.35,.width = c(.66, .95))+
  geom_point(data=LNU_cover_prop , alpha=.2)+
  geom_jitter(data=LNU_cover_prop, alpha =.2)+
  facet_wrap(~year)+
  labs(x="Fire Frequency", y= "Proportion Native Cover",
       fill="credible interval")+
  theme(legend.position = "bottom")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank())

#slope of line at average number of burns
emtrends(m.prop.cover.rich3, ~ num_burn, var = "num_burn", 
         at = list(num_burn = c(1:7)),
         regrid = "response")
 #num_burn num_burn.trend lower.HPD upper.HPD
#     3.17        -0.0815    -0.113   -0.0505

## OVERALL TREND 
emtrends(m.prop.cover.rich3, ~ 1, var = "num_burn", 
         regrid = "response")

#AVERAGE MARGINAL EFFECT
# emtrends()-based AMEs
grand_mean_ame <- m.prop.cover.rich %>% 
  emtrends(~ num_burn,
           var = "num_burn",
           at = list(num_burn = seq(1,5,by=1)),
           regrid = "response") %>% 
  gather_emmeans_draws()

ggplot(grand_mean_ame,aes(x = .value / 10, 
                      fill = factor(num_burn))) +
  stat_halfeye(slab_alpha = 0.75) +
 # scale_fill_manual() +
  labs(x = "Average marginal effect of a\n increase in 1 fire recurrence",
       y = "Proportion of native species", fill = "Fire Frequency") +
  theme(legend.position = "bottom")

ggplot(grand_mean_ame,aes(x = .value / 10)) +
  stat_halfeye(slab_alpha = 0.75, 
               point_interval = "median_hdi",
               fill = "#0c4c8a") +
  labs(x = "Average marginal effect of a\n increase in 1 fire recurrence",
       y = "Proportion of native species", fill = "Fire Frequency") +
  theme(legend.position = "bottom")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())


#get adjusted means
em <- emmeans(m.prop.cover.rich3,
              ~ num_burn,
              at = list(num_burn = seq(1,7,by=1)))
em
cont <- contrast(em, "tukey")
cont
#get the posterior draws from the contrasts
cont_posterior <- gather_emmeans_draws(cont)
cont_posterior
#plot
ggplot(cont_posterior,
       aes(y = contrast, x = .value)) +
  stat_halfeye()+
 # facet_wrap(~num_burn) +
  geom_vline(xintercept = 0, color = "red", lty = 2)


posterior_beta <- m.prop.cover.rich %>% 
  gather_draws(`b_.*`, regex = TRUE) %>% 
  mutate(component = ifelse(str_detect(.variable, "phi_"), "Precision", "Mean"),
         intercept = str_detect(.variable, "Intercept"))
posterior_beta

ggplot(posterior_beta, 
       aes(x = .value, y = fct_rev(.variable), fill = component)) +
  geom_vline(xintercept = 0) +
  stat_halfeye(aes(slab_alpha = intercept), 
               .width = c(0.8, 0.95), point_interval = "median_hdi") +
  scale_fill_viridis_d(option = "viridis", end = 0.6) +
  scale_slab_alpha_discrete(range = c(1, 0.4)) +
  guides(fill = "none", slab_alpha = "none") +
  labs(x = "Coefficient", y = "Variable",
       caption = "80% and 95% credible intervals shown in black") +
  facet_wrap(vars(component), ncol = 1, scales = "free_y") 


```



# Seedling Density Regression Obligate seeders

use bernoulli prior and constrain the priors

prior1 <- prior("normal(0,1)", class = "b") +
  prior("student_t(3, 0, 1)", class = "sds", coef = "s(transect_dist_m, by = Plot)")
  # only 1 coef for this. t(3,0,1) is aki vehtarhi's favorite weakly informative prior.
  I changed this from t(3, 0, 2.5)


when no prior used, model cannot be fit, rhat ~1.04 and very low estimated sample size. This is probably because one or more of the predictors causes full separation of the outcome. See page 256 of Regression and other stories for more information.


```{r Seedling Density OBLIGATE-S }


#####DENSITY

shrub_seedling_data <- read.csv("data/clean/shrub_seedling_data_ALL.csv")

seedling_data <- left_join(shrub_seedling_data, plot.description_LNU, by="PlotID")
seedling_data <- left_join(seedling_data, species.short, by ="spp")

#check data
seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  ggplot(aes(x=num_burn, y=avg.count, color=spp))+
  geom_smooth(method = "lm")+
  geom_point()+
  geom_jitter()+
  facet_wrap(~fac.obl)

seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  ggplot(aes(x=num_burn, y=prop.presence, color=spp))+
   geom_smooth(method = "lm")+
  geom_point()+
  geom_jitter()+
  facet_wrap(~fac.obl)

#check numbe of 0s
100*sum(shrub_density_long$density == 0)/nrow(shrub_density_long)

##Visualize data
str(seedling_data)
#shrub_density_total$num_burn <- as.factor(shrub_density_total$num_burn)

shrub_density_sum <- seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  group_by(num_burn, fac.obl) %>% 
  dplyr::summarise(mean_den = mean(avg.count),
            max_den = max(avg.count),
            min_den = min(avg.count),
            n_obs = n(),
            sd = sd(avg.count),
            se= sd/sqrt(n_obs))

ggplot(shrub_density_sum, 
       aes(x=as.factor(num_burn), y=mean_den, fill=fac.obl))+
  geom_bar(stat = "identity", position = position_dodge())+
  scale_fill_manual(values = cal_palette("sierra1")) +
  geom_errorbar(aes(ymax=mean_den + se, ymin=mean_den-se),
                width=.2,
                position=position_dodge(.9))+
  labs(x="Fire Frequency", y= "Average seedling density",
       fill="")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())

shrub_density_sum <- seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  group_by(num_burn, fac.obl, spp) %>% 
  dplyr::summarise(mean_den = mean(avg.count),
            max_den = max(avg.count),
            min_den = min(avg.count),
            n_obs = n(),
            sd = sd(avg.count),
            se= sd/sqrt(n_obs))

ggplot(shrub_density_sum, 
       aes(x=as.factor(num_burn), y=mean_den, fill=spp))+
  geom_bar(stat = "identity")+
  facet_wrap(~fac.obl)+
   labs(x="Fire Frequency", y= "Average seedling density",
       fill="")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())

hist(seedling_data$avg.count)
hist(seedling_data$prop.presence)
mean(seedling_data$avg.count). #.101
mean(seedling_data$prop.presence). #.022
sd(seedling_data$avg.count) #.768
sd(seedling_data$prop.presence) #.099

#look at OBL-S only
str(shrub_density_OBLS)
range(shrub_density_OBLS$prop.presence)

shrub_density_OBLS <- seedling_data %>%
  filter(fac.obl == "OBL-S") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))

shrub_density_OBLS$year <- as.factor(shrub_density_OBLS$year)
shrub_density_FAC$year <- as.factor(shrub_density_FAC$year)

plot(shrub_density_OBLS$num_burn, shrub_density_OBLS$presence)
plot(shrub_density_OBLS$TSLF, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$hli, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$ppt, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$tmean, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$elevation, shrub_density_OBLS$prop.presence)

shrub_density_OBLS %>% 
  dplyr::count(prop.presence == 0) %>% 
  mutate(prop = n/sum(n)) 

cor(shrub_density_OBLS[,c("num_burn","TSLF",
                          "hli","slope",
                          "ppt","tmean","elevation")])
pairs(shrub_density_OBLS[,c("num_burn","TSLF",
                          "hli","slope",
                          "ppt","tmean","elevation")])

ggplot(shrub_density_OBLS, aes(x=num_burn, y=presence,
                               color=spp))+
  geom_point()+
  geom_jitter()


priors <- c(set_prior("normal(0,1)", class = "b"),
            set_prior("student_t(3, 0, 1)", class = "Intercept"))
  # only 1 coef for this. t(3,0,1) is aki vehtarhi's favorite weakly informative prior.
 # I changed this from t(3, 0, 2.5)
prior_summary(m.shrubDensityOBL)
m.shrubDensityOBL <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL, file = "models/shrubDensityOBL.rda")
load("models/shrubDensityOBL.rda")

tidy(m.shrubDensityOBL, effects = "fixed")
summary(m.shrubDensityOBL)
conditional_effects(m.shrubDensityOBL)
plot(m.shrubDensityOBL)
pp_check(m.shrubDensityOBL)
bayes_R2(m.shrubDensityOBL)

m.shrubDensityOBL2 <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn * year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL2, file = "models/shrubDensityOBL2.rda")
load("models/shrubDensityOBL2.rda")

summary(m.shrubDensityOBL2b)
conditional_effects(m.shrubDensityOBL2b)
plot(m.shrubDensityOBL2)
pp_check(m.shrubDensityOBL2)
bayes_R2(m.shrubDensityOBL2b)
loo(m.shrubDensityOBL,m.shrubDensityOBL2b)


m.shrubDensityOBL2b <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL2b, file = "models/shrubDensityOBL2b.rda")
load("models/shrubDensityOBL2b.rda")



m.shrubDensityOBL3 <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn + year + hli,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL3, file = "models/shrubDensityOBL3.rda")
load("models/shrubDensityOBL3.rda")

summary(m.shrubDensityOBL3)
conditional_effects(m.shrubDensityOBL3)
plot(m.shrubDensityOBL3)
pp_check(m.shrubDensityOBL3)
bayes_R2(m.shrubDensityOBL3)
loo(m.shrubDensityOBL, m.shrubDensityOBL2b, m.shrubDensityOBL3)


pred <- m.shrubDensityOBL2b %>% 
  epred_draws(newdata = expand_grid(num_burn=seq(1,7,by=.1),
                                      year=c(2021, 2022)))
pred

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of obligate seeder",
       fill = "Credible interval") +
  facet_wrap(~year)+
  theme(legend.position = "bottom")+
    theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())


shrub_density_OBLS %>% 
  data_grid(num_burn=seq(1,7,by=.1),
            year=c(2021, 2022)) %>% 
  add_draws(posterior_epred(m.shrubDensityOBL2b, newdata= .)) %>% 
  ggplot(aes(x=num_burn, y=presence))+
  stat_lineribbon(aes(y=.value),.width = c(.66, .95))+
  #geom_point(data=shrub_density_OBLS , alpha=.2)+
  #geom_jitter(data=shrub_density_OBLS, alpha =.2)+
  scale_fill_brewer(palette = "Blues")+
  facet_wrap(~year)+
  labs(x="Fire Frequency", y= "Presence of obligate seeder",
       fill="credible interval")+
  theme(legend.position = "bottom")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())




```

# Shrub density FACULTATIVE

```{r}
####### Facultative
shrub_density_FAC <- seedling_data %>%
  filter(fac.obl == "FAC") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence)) 

unique(shrub_density_FAC$spp)
shrub_density_FAC$year <- as.factor(shrub_density_FAC$year)
ggplot(shrub_density_FAC, aes(x=num_burn, y=presence,
                               color=spp))+
  geom_point()+
  geom_jitter()

m.shrubDensityFAC <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC, file = "models/shrubDensityFAC.rda")
load("models/shrubDensityFAC.rda")

tidy(m.shrubDensityFAC, effects = "fixed")
summary(m.shrubDensityFAC)
conditional_effects(m.shrubDensityFAC)
plot(m.shrubDensityFAC)
pp_check(m.shrubDensityFAC)
bayes_R2(m.shrubDensityFAC)

pred <- m.shrubDensityFAC %>% 
  epred_draws(newdata = expand_grid(num_burn=seq(1,7,by=.1)))
pred

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of facultative seeder",
       fill = "Credible interval") +
  theme(legend.position = "bottom")

m.shrubDensityFAC2 <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC2, file = "models/shrubDensityFAC2.rda")
load("models/shrubDensityFAC2.rda")

summary(m.shrubDensityFAC2)
conditional_effects(m.shrubDensityFAC2)
plot(m.shrubDensityFAC2)
pp_check(m.shrubDensityFAC2)
bayes_R2(m.shrubDensityFAC2)
loo(m.shrubDensityFAC,m.shrubDensityFAC2)

m.shrubDensityFAC3 <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn + year + hli,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC3, file = "models/shrubDensityFAC3.rda")
load("models/shrubDensityFAC3.rda")

summary(m.shrubDensityFAC3)
conditional_effects(m.shrubDensityFAC3)
plot(m.shrubDensityFAC3)
pp_check(m.shrubDensityFAC3)
bayes_R2(m.shrubDensityFAC3)
loo(m.shrubDensityFAC,m.shrubDensityFAC2, m.shrubDensityFAC3)

nd <- expand_grid(num_burn=seq(1,7,by=.1),
                  year=unique(shrub_density_OBLS$year))

pred <- m.shrubDensityFAC2%>% 
    epred_draws(newdata = nd)

head(pred)

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of facultative seeder",
       fill = "Credible interval") +
    facet_wrap(~year)+
  theme(legend.position = "bottom")+
    theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())


```

# shrub density by individual FAC spp

```{r}
#ADFA ONLY
shrub_density_ADFA <- seedling_data %>%
  filter(spp == "ADFA") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_3top$year <- as.factor(shrub_density_3top$year)


m.shrubDensityADFA <- brm(data = shrub_density_ADFA,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityADFA, file = "models/shrubDensityADFA.rda")
load("models/shrubDensityADFA.rda")

summary(m.shrubDensityADFA)
conditional_effects(m.shrubDensityADFA)
bayes_R2(m.shrubDensityADFA)

unique(seedling_data$spp)
shrub_density_ERICAL <- seedling_data %>%
  filter(spp == "ERICAL") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_ERICAL$year <- as.factor(shrub_density_ERICAL$year)

plot(shrub_density_ERICAL$presence, shrub_density_ERICAL$num_burn)

m.shrubDensityERCAL <- brm(data = shrub_density_ERICAL,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityERCAL, file = "models/shrubDensityERCAL.rda")
load("models/shrubDensityERCAL.rda")

summary(m.shrubDensityERCAL)
conditional_effects(m.shrubDensityERCAL)

shrub_density_LEPCAL <- seedling_data %>%
  filter(spp == "LEPCAL") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_LEPCAL$year <- as.factor(shrub_density_LEPCAL$year)


m.shrubDensityLEPCAL <- brm(data = shrub_density_LEPCAL,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityLEPCAL, file = "models/shrubDensityLEPCAL.rda")
load("models/shrubDensityLEPCAL.rda")
summary(m.shrubDensityLEPCAL)
conditional_effects(m.shrubDensityLEPCAL)

nd <- expand_grid(num_burn=seq(1,7,by=.1),
                  year=unique(shrub_density_OBLS$year))

pred <- m.shrubDensityFAC%>% 
    epred_draws(newdata = nd)
pred_adfa <- m.shrubDensityADFA%>% 
    epred_draws(newdata = nd) %>% 
  mutate(spp = "ADFA")
pred_ercal <- m.shrubDensityERCAL%>% 
    epred_draws(newdata = nd) %>% 
  mutate(spp = "ERCAL") 
pred_lepcal <- m.shrubDensityLEPCAL%>% 
    epred_draws(newdata = nd) %>% 
  mutate(spp = "LEPCAL")

pred_all <- rbind(pred_adfa, pred_ercal, pred_lepcal)

ggplot(pred_all, aes(x=num_burn, y=.epred, fill=spp))+
  stat_lineribbon(alpha=.5)+
  #scale_fill_brewer(palette = "Blues")+
   scale_fill_manual(values = cal_palette("chaparral1")) +
  facet_grid(spp~year, space = "free_x", scales = "free_x")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of facultative seeder",
       fill = "Credible interval") +
  theme(legend.position = "bottom")+
   theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank(),
        legend.position = "none")
  
```



# shrub resprout height

```{r}
#####RESP HEIGHT

shrub_resp_ht <- read.csv("data/clean/shrub_resprout_height_ALL.csv")

shrub_resp_ht <- left_join(shrub_resp_ht, plot.description_LNU, by="PlotID")
shrub_resp_ht <- left_join(shrub_resp_ht, species.short, by ="spp")

str(shrub_resp_ht)
shrub_resp_ht$num_burn <- as.factor(shrub_resp_ht$num_burn)

shrub_resp_ht %>% 
  filter(spp == "ADFA") %>% 
  ggplot(aes(x=num_burn, y=mean.ht))+
  geom_boxplot()
  geom_jitter()

```

