---
title: "LNU Analysis"
author: "Ashley Grupenhoff"
date: "5/6/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/ashle/OneDrive/Documents/R/LNU_chaparral/LNU_chaparral")
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(plyr)
library(brms)
library(rstan)
library(tidybayes)
library(bayesplot)
library(bayestestR)
library(emmeans)
library(calecopal)
library(car) #use VIF

#run faster
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

```

## Input clean data
```{r data}
#raw
TOT_species_LNU <- read.csv("data/raw/TOT_species_LNU.csv")
subplot_species_LNU <- read.csv("data/raw/SubPlot_SPP_LNU.csv")
plot.description_LNU <- read.csv("data/clean/LNU_plot_description_CLEAN.csv")
severity_LNU <- read.csv("data/raw/Severity_LNU.csv")
GroundCover_LNU <- read.csv("data/raw/GroundCover_LNU.csv")
Mortality_LNU <- read.csv("data/raw/Mortality_LNU.csv")
SpeciesList <- read.csv("data/raw/SpeciesList_jan23.csv")



species.short <- SpeciesList %>% 
  dplyr::select(spp, Lifeform, Native_nonnative, fac.obl) 


ggplot(plot.description_LNU,
       aes(x=num_burn, y=hli))+
  geom_point()

```


## Severity 

```{r severity}
  
sevdata <- ddply(severity.plotdescription.LNU, c("num_burn"),
                 summarise,
                 N = sum(!is.na(mean_diam_mm)),
                 mean_diam_mm_avg = mean(mean_diam_mm, na.rm=TRUE),
                 sd= sd(mean_diam_mm, na.rm = TRUE),
                 se = sd/sqrt(N)) 


ggplot(data=sevdata %>%  filter(num_burn != "2"), aes(x=as.factor(num_burn), y=mean_diam_mm_avg))+
                    geom_errorbar(aes(ymin=mean_diam_mm_avg-se, ymax=mean_diam_mm_avg+se), width=.1, size=.7)+
                    geom_line()+
                    geom_point(size=3, aes(colour=factor(num_burn)))+
                    scale_colour_viridis_d()+
                     xlab("Fire frequency")+
                     ylab("Fire Severity")+
                    theme_bw()+
                   theme(legend.title = element_blank(),
                           axis.text = element_text(size=15),
                            text = element_text(size = 16),
                          panel.grid = element_blank())
ggsave(file="figures/sev~freq.svg", width = 4.5, height = 3)
ggsave(file="figures/sev~freq.png", width = 4.5, height = 3)





#LINEAR MODEL
qqnorm(severity.plotdescription.LNU$mean_diam_mm, pch = 1, frame = FALSE)
qqline(severity.plotdescription.LNU$mean_diam_mm, col = "steelblue", lwd = 2)

m.sev <- lm(num_burn ~ mean_diam_mm ,
                 data = severity.plotdescription.LNU, REML = F)
summary(m.sev)
coef(summary(m.nativeRich))
plot(m.sev)

```



# NMDS
xxxxxxxxx
This file is not up to date
xxxxxxxxxxx

```{r}
library(vegan)

load(file = "data/clean/LNU_subplot_wide_species.RData")

#make community matrix on which to base ordination
LNUspecies = LNU_subplot_wide %>% select(!PlotID)
#columns that contain descriptive data
LNUplot_ord = LNU_subplot_wide %>% 
  select(PlotID) 
LNUplot_env <- left_join(LNUplot_ord, plot.description.short %>% distinct(), by = "PlotID")

set.seed(123) #reproduce same results
NMDS <- metaMDS(LNUspecies, distance="bray", k=2) #no transformation of species data is made here prior to bray curtis dissimilarities being calculated. 
NMDS

#env.fit
nmds_plot <- cbind(NMDS$point, LNUplot_env)
nmds_species <- left_join(cbind(as.data.frame(NMDS$species), 
                                as.data.frame(row.names(as.data.frame(NMDS$species)))), 
                               # %>% rename(spp = "row.names(as.data.frame(NMDS$species))")
                                species.short, by = c("row.names(as.data.frame(NMDS$species))"="spp" ))

nmds_plot$num_burn <- as.factor(nmds_plot$num_burn)

ggplot(nmds_plot %>% filter(num_burn != "7"), aes(x=MDS1, y=MDS2))+
  geom_point(size = 4, aes(x=MDS1, y=MDS2, color = num_burn))+
  #geom_point(data= nmds_species, size = 1.8, alpha = 0.5, aes(x=MDS1, y=MDS2, 
  #                                               shape = Native_nonnative))
  stat_ellipse(aes(x=MDS1, y=MDS2, color = num_burn))+
  scale_color_viridis_d()+
  guides(col=guide_legend("Fire Frequency"))+
  theme(axis.text = element_text(size=15),
        text = element_text(size = 16),
        panel.grid = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size=11))
ggsave(file="figures/NMDS.svg", width = 5, height = 3)
ggsave(file="figures/NMDS.png", width = 5, height = 3)



```



# Richness clean

Calculated richness by each sub plot probably want to do this by total plot?

```{r Richness, echo=FALSE}
#calculate richness

LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")

#sum up the number of non-zero entries per row 
#first column ignored ([,-1]) since this is the site name, not species count
LNU_richness_nonnative <- ddply(LNU_sub_nonnative_wide,~plot_yr_quad,function(x) {
  data.frame(NONNATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness_native <- ddply(LNU_sub_native_wide,~plot_yr_quad,function(x) {
  data.frame(NATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness <- left_join(LNU_richness_native, LNU_richness_nonnative, by="plot_yr_quad")

LNU_richness_proportion <- LNU_richness %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  mutate(prop.native = (NATIVE_RICHNESS/(NATIVE_RICHNESS + NONNATIVE_RICHNESS))) %>% 
  separate(plot_yr_quad, c("plot_year", "quad"), sep=" ") %>% 
  group_by(plot_year) %>% 
  dplyr::summarise(mean_native_rich = mean(NATIVE_RICHNESS),
            mean_nonnative_rich = mean(NONNATIVE_RICHNESS),
            mean_propNative = mean(prop.native))
  

LNU_richness_final <- LNU_richness_proportion %>% 
  pivot_longer(!plot_year,
               names_to = "native.nonnative.prop",
               values_to = "richness") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

LNU_richness_final <- left_join(LNU_richness_final, plot.description_LNU, by="PlotID")


write_csv(LNU_richness_final, "data/clean/LNU_subplot_RICHNESS.csv")
            
```

# model richness random forest

```{r RF RICH}
LNU_richness <- read.csv("data/clean/LNU_subplot_RICHNESS.csv")

str(LNU_richness)
LNU_richness$num_burn <- as.factor(LNU_richness$num_burn)
LNU_richness$TSLF <- as.factor(LNU_richness$TSLF)
LNU_richness$mCC_FRI <- as.factor(LNU_richness$mCC_FRI)
LNU_richness$aspect_name <- as.factor(LNU_richness$aspect_name)
LNU_richness$year <- as.factor(LNU_richness$year)
LNU_richness$elevation <- as.numeric(LNU_richness$elevation)

propnativeRich <- LNU_richness %>% 
  filter(native.nonnative.prop == "mean_propNative")  %>% 
  filter(PFR != "oak woodland")
propnativeRich_small <- propnativeRich %>% 
  dplyr::select(richness, year, num_burn, mCC_FRI, TSLF,
         ppt, tmean, elevation, slope, aspect_name, hli)

rich_mod <- bf(richness ~ num_burn + cover)
cover_mod <- bf(cover ~ firesev)

k_fit_brms <- brm(rich_mod +
                  cover_mod + 
                  set_rescor(FALSE), 
                data=keeley,
                cores=4, chains = 2)

```

# model richness regression 

```{r regression RICH}


LNU_richness <- read.csv("data/clean/LNU_subplot_RICHNESS.csv")

str(LNU_richness)
LNU_richness$num_burn <- as.factor(LNU_richness$num_burn)
LNU_richness$TSLF <- as.factor(LNU_richness$TSLF)
LNU_richness$mCC_FRI <- as.factor(LNU_richness$mCC_FRI)
LNU_richness$aspect_name <- as.factor(LNU_richness$aspect_name)
LNU_richness$year <- as.factor(LNU_richness$year)
LNU_richness$elevation <- as.numeric(LNU_richness$elevation)
LNU_richness$crrnFRI <- as.factor(LNU_richness$crrnFRI)



str(LNU_richness)
unique(LNU_richness$native.nonnative.prop)

nativeRich <- LNU_richness %>% 
  filter(native.nonnative.prop == "mean_native_rich") %>% 
 filter(PFR != "oak woodland")
nonnativeRich <- LNU_richness %>% 
  filter(native.nonnative.prop == "mean_nonnative_rich")  %>% 
  filter(PFR != "oak woodland")
propnativeRich <- LNU_richness %>% 
  filter(native.nonnative.prop == "mean_propNative")  %>% 
  filter(PFR != "oak woodland") %>% 
  dplyr::rename(prop_native_rich = richness)

##BAYESIAN
#repeated measures looking at richness based on different fire frequencies 

ggplot(propnativeRich, aes(x=num_burn, y=prop_native_rich,
                           fill = year))+
  geom_boxplot()

propnativeRich_small <- propnativeRich %>% 
  dplyr::select(prop_native_rich, year, num_burn, mCC_FRI, TSLF,
         ppt, tmean, elevation, slope, aspect_name, hli) %>% 
  #can't have exactly 0 or 1
  mutate(prop_native_rich = ifelse(prop_native_rich == 1, 0.999, prop_native_rich))

range(propnativeRich_small$prop_native_rich)
#check if covariates are correlated
hist(propnativeRich$prop_native_rich)
plot(propnativeRich$ppt, propnativeRich$tmean)
plot(propnativeRich$ppt, propnativeRich$hli)
plot(propnativeRich$tmean, propnativeRich$hli)
plot(propnativeRich$TSLF, propnativeRich$num_burn)
plot(propnativeRich$hli, propnativeRich$aspect_name)
plot(propnativeRich$crrnFRI, propnativeRich$num_burn)
plot(propnativeRich$num_burn, propnativeRich$prop_native_rich)
plot(propnativeRich$TSLF, propnativeRich$prop_native_rich)

str(propnativeRich_small)
data <- propnativeRich_small[ , c("ppt", "tmean", "elevation", "slope", "hli")]
cor(data) #this looks good!!

#determine outliers 
min(propnativeRich_small$prop_native_rich) #0.217
max(propnativeRich_small$prop_native_rich) #1
mean(propnativeRich_small$prop_native_rich) #0.52
ggplot(propnativeRich_small) +
  aes(x = "", y = prop_native_rich) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()
hist(propnativeRich$prop_native_rich)

m.propnatRich <- brm(
  bf(prop_native_rich ~ 1 + num_burn, 
     phi ~ num_burn),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234,
  file = "models/nativeRich_jan.30.23")

summary(m.propnatRich)
conditional_effects(m.propnatRich)
bayes_R2(m.propnatRich)
plot(m.propnatRich)

#visulaize posterior
beta_bayes_pred <- m.propnatRich %>% 
  epred_draws(newdata = tibble(num_burn = unique(propnativeRich$num_burn)))

ggplot(beta_bayes_pred, aes(x = num_burn, y = .epred, fill = num_burn)) +
 #   stat_pointinterval(position = position_dodge(width = .4),
#                     .width = c(.95))+
 stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi") +
  scale_fill_manual(values = cal_palette("sierra1")) +
  guides(fill = "none") +
  labs(x = "Predicted proportion native species", 
       y = "Fire frequency",
       caption = "80% and 95% credible intervals shown in black") 


m.propnatRich2 <- brm(
  bf(prop_native_rich ~ 1 + num_burn * year, 
     phi ~ num_burn * year),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234,
  file = "models/nativeRich2_jan.30.23")

loo(m.propnatRich, m.propnatRich2)
summary(m.propnatRich2)
conditional_effects(m.propnatRich2)
pp_check(m.propnatRich2)
bayes_R2(m.propnatRich2)

m.propnatRich3 <- brm(
  bf(prop_native_rich ~ 1 + num_burn * year + hli, 
     phi ~ num_burn * year + hli),
  data = propnativeRich_small,
  family = Beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores=4,
  seed = 1234,
  file = "models/nativeRich3_jan.30.23")

summary(m.propnatRich3)
conditional_effects(m.propnatRich3)
bayes_R2(m.propnatRich3)

loo(m.propnatRich, m.propnatRich2, m.propnatRich3)
summary(n.natRich3)
hist(resid(n.natRich3))
pp_check(n.natRich2)
bayes_R2(n.natRich)


```


# Shannon Diversity

This data is overdispersed (mean < variance) and has a long tail. Need to figure out another distribution. Negative binomial doesn't work since not integer data.
```{r Shannon}

######SHANNON DIVERSITY
#sum up the number of non-zero entries per row 
#first column ignored ([,-1]) since this is the site name, not species count
LNU_shan_nonnative <- ddply(LNU_sub_nonnative_wide,~plot_yr_quad,function(x) {
  data.frame(NONNATIVE_shanDiv=diversity(x[-2], index="shannon"))})

LNU_shan_native <- ddply(LNU_sub_native_wide,~plot_yr_quad,function(x) {
  data.frame(NATIVE_shanDiv=diversity(x[-2], index="shannon"))})

LNU_shanDiv <- left_join(LNU_shan_native, LNU_shan_nonnative, by="plot_yr_quad")

LNU_shanDiv <- LNU_shanDiv %>% 
  mutate_if(is.numeric, ~replace_na(.,0))

LNU_shanDiv <- LNU_shanDiv %>% 
  pivot_longer(!plot_yr_quad,names_to = "native.nonnative",
               values_to = "shanDiv") %>% 
  separate(plot_yr_quad, c("plot_year", "quad"), sep=" ") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

LNU_shanDiv <- left_join(LNU_shanDiv,severity.plotdescription.LNU, by="PlotID")

LNU_shanDiv$num_burn <- as.factor(LNU_shanDiv$num_burn)
str(LNU_shanDiv)

nativeShan <- LNU_shanDiv %>% 
  filter(native.nonnative == "NATIVE_shanDiv") %>% 
  filter(Location != "CacheCreek")
nonnativeShan <- LNU_shanDiv %>% 
  filter(native.nonnative == "NONNATIVE_shanDiv") %>% 
  filter(Location != "CacheCreek")

write.csv(LNU_shanDiv, "data/clean/LNU_subplot_shanDiv.csv")


#Bayesian model




#gaussian based model seems better than gamma 
str(nativeShan)
hist(nativeShan$shanDiv)
mean(nativeShan$shanDiv)
sd(nativeShan$shanDiv)

n.natShan <- brm(shanDiv ~ num_burn, 
                 family = negbinomial(),
                 data = nativeShan,
                 prior=c(set_prior("normal(0,2)", class= "b")), 
                 cores=4,
                 file = "models/nativeShan")
summary(n.natShan)
hist(resid(n.natShan))
pp_check(n.natShan)


plot(conditional_effects(n.natShan))

emmeans(n.natShan, specs= pairwise ~num_burn)

natShan.model <- n.natShan %>% 
  emmeans( ~num_burn) %>% 
  gather_emmeans_draws() %>% 
  mutate(native_shannon = .value)
natShan.model

#now plot!!
natShan_plot <- ggplot(data = natShan.model,
                           aes(x = num_burn, y=native_shannon, fill = native_shannon))+
  stat_halfeye()+
  labs(x = expression(italic("Fire Frequency")),
       y = "Native Shannon Diversity") +
  scale_fill_viridis(discrete = TRUE)+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())
natShan_plot


hdi(n.natShan)
#get adjusted means
warp_em <- emmeans::emmeans(n.natShan, ~ num_burn)
warp_em
#get all possible constrasts
cont <- contrast(warp_em, "tukey")
cont
#get posterior draws
con_posterior <- gather_emmeans_draws(cont)
#plot
ggplot(con_posterior,
       aes(y = contrast, x = .value)) +
  geom_halfeyeh() +
  geom_vline(xintercept = 0, color = "red", lty = 2)
emmip(n.natShan,  ~ num_burn, CIs = TRUE, cov.reduce = range)



#gaussian based model seems better than gamma 
str(nonnativeShan)
n.nonnatShan <- brm(shanDiv ~ num_burn, data = nonnativeShan,
                 prior=c(set_prior("normal(0,2)", class= "b")), 
                 cores=4)
summary(n.nonnatShan)
hist(resid(n.nonnatShan))
pp_check(n.nonnatShan)
plot(n.nonnatShan)

plot(conditional_effects(n.nonnatShan))

emmeans(n.nonnatShan, specs= pairwise ~num_burn)

nonnatShan.model <- n.nonnatShan %>% 
  emmeans( ~num_burn) %>% 
  gather_emmeans_draws() %>% 
  mutate(nonnative_shannon = .value)
nonnatShan.model

#now plot!!
nonnatShan_plot <- ggplot(data = nonnatShan.model,
                           aes(x = num_burn, y=nonnative_shannon, fill = nonnative_shannon))+
  stat_halfeye()+
  labs(x = expression(italic("Fire Frequency")),
       y = "Nonnative Shannon Diversity") +
  scale_fill_viridis(discrete = TRUE)+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())
nonnatShan_plot

hypnonNatShan = hypothesis(n.nonnatShan,
                        hypothesis = c("Intercept=0",
                                       "Intercept+num_burn2=0",
                                       "Intercept+num_burn3=0",
                                       "Intercept+num_burn4=0",
                                       "Intercept+num_burn5=0"))
toplot = hypnonNatShan$samples
toplot
names(toplot) = c("1 Fire","2 Fire","3 Fires","4 Fires","5 Fires")
mcmc_intervals(toplot, prob_outer = .95, prob=.68)+
xlab("Nonnative Shannon Diversity")



```

# Seedling Density Regression (prop Native species)

```{r Seedling Density }


#####DENSITY
shrub_density_long <- read.csv("data/clean/LNU_subplot_shrub_density_long.csv")
shrub_density_long <- left_join(shrub_density_long, plot.description_LNU, by="PlotID")
shrub_density_long <- left_join(shrub_density_long, species.short, by ="spp")


plot(density ~ as.factor(num_burn), data=shrub_density_long %>% filter(avg.sum =="avg.count"))
plot(density ~ as.factor(num_burn), data=shrub_density_long %>% filter(avg.sum =="sum.count"))


#check numbe of 0s
100*sum(shrub_density_long$density == 0)/nrow(shrub_density_long)


#zero inflated model for obligate seeders only
shrub_density_OBLS <- shrub_density_long %>%
  filter(avg.sum == "sum.count") %>% 
  filter(seed.resp == "SEEDLING") %>% 
  filter(fac.obl == "OBL-S") %>% 
  filter(spp != "ACMGLA") %>% 
  mutate(presence = case_when(
    density == 0 ~ 0,
    density > 0 ~ 1
  ))
unique(shrub_density_OBLS$spp)

shrub_density_OBLS$num_burn <- as.factor(shrub_density_OBLS$num_burn)

hist(shrub_density_OBLS$presence)
mean(shrub_density_OBLS$density)
sd(shrub_density_OBLS$density)

ggplot(shrub_density_OBLS, aes(x=num_burn, y = presence))+
  geom_point()

prior2 <- c(
    prior(normal(0, 10), class = Intercept, coef = ""),
    prior(normal(0, 10), class = b)
    )

n.shrubDensityOBL <- brm(data = shrub_density_OBLS,
                      presence ~ 1+ num_burn,
                      family = zero_inflated_binomial(),
                     # prior = prior2,
                      #control = list(adapt_delta = 0.998, max_treedepth = 15),
                    #iter = 5000,
                  #warmup = 1000, c
                  cores = 4, chains = 4,
                 file = "models/shrubDensityOBL")


n.shrubDensityOBL2 <- brm(data = shrub_density_OBLS,
                      density ~ 1+ num_burn*cool.warm_slope,
                       family = binomial(link = "logit"),
                      prior = c(set_prior('horseshoe(1)')),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                  iter = 5000,
                  warmup = 1000, cores = 4, chains = 4,
                 file = "models/shrubDensityOBL2")

summary(n.shrubDensityOBL)
plot(n.shrubDensityOBL)
pp_check(n.shrubDensityOBL)
conditional_effects(n.shrubDensityOBL)

OBLS.model <- n.shrubDensityOBL%>% 
  emmeans( ~num_burn) %>% 
  gather_emmeans_draws() %>% 
  mutate(density = .value)
OBLS.model

OBLS.model_plot <- ggplot(data = OBLS.model,
                           aes(x = num_burn, y=density))+
  stat_pointinterval(position = position_dodge(width = .4),
                     .width = c(.95))+
  labs(x = expression(italic("Fire Frequency")),
       y = "Obligate seeder density") +
 scale_color_manual(values = cal_palette("gayophytum")) +
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())
OBLS.model_plot




#zero inflated model for facultative seeders only
shrub_density_FAC <- shrub_density_long %>%
  filter(seed.resp == "SEEDLING") %>% 
  filter(fac.obl == "FAC") %>% 
  filter(spp != "MIMAUR") %>% 
    filter(spp != "HOLDIS") 
unique(shrub_density_FAC$spp)

M2 <- zeroinfl(density_ha ~ as.factor(num_burn),
               dist = "negbin",
          data = shrub_density_FAC)
summary(M2)
confint(M2)
tab_model(M2, file = "tables/FACS_model_output.html")
#check for over/underdispersion
E3 <- resid(M2, type = "pearson")
N <- nrow(shrub_density_long)
p <- length(coef(M2))
sum(E3^2)/(N-p)
#.286 nooo 

mydf2 <- ggpredict(M2, type= "zi_random", terms = "num_burn") 
mydf2
ggplot(mydf2, aes(as.factor(x), predicted))+
  geom_point(size=3,position = position_dodge(.1), aes(color=as.factor(x))) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
              position = position_dodge(.1),
              width=.1, size=.3) +
  scale_colour_viridis_d()+
  xlab("Fire frequency")+
  ylab("Facultative Seedling density/Ha")+
  theme_bw()+
  theme(legend.position = "none",
  axis.text = element_text(size=12),
  text = element_text(size = 14),
  panel.grid = element_blank())
ggsave(file="figures/fac_seed_predicted.svg", width = 4.5, height = 3.5)
ggsave(file="figures/fac_seed_predicted.png", width = 4.5, height = 3.5)



#zero inflated model for ADFA only
ADFA_density_FAC <- shrub_density_long %>%
  filter(seed.resp == "SEEDLING") %>% 
  filter(fac.obl == "FAC") %>% 
  filter(spp == "ADFA") 
unique(ADFA_density_FAC$spp)

M2 <- zeroinfl(density_ha ~ as.factor(num_burn),
               dist = "negbin",
          data = ADFA_density_FAC)
summary(M2)
#check for over/underdispersion
E3 <- resid(M2, type = "pearson")
N <- nrow(shrub_density_long)
p <- length(coef(M2))
sum(E3^2)/(N-p)
#.286 nooo 

mydf2 <- ggpredict(M2, type= "zi_random", terms = "num_burn") 
mydf2
ggplot(mydf2, aes(as.factor(x), predicted))+
  geom_point(size=3,position = position_dodge(.1), aes(color=as.factor(x))) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
              position = position_dodge(.1),
              width=.1, size=.3) +
  scale_colour_viridis_d()+
  xlab("Fire frequency")+
  ylab("ADFA Seedling density/Ha")+
  theme_bw()+
  theme(legend.position = "none",
  axis.text = element_text(size=12),
  text = element_text(size = 14),
  panel.grid = element_blank())
ggsave(file="figures/ADFA_seed_predicted.svg", width = 4.5, height = 3.5)
ggsave(file="figures/ADFA_seed_predicted.png", width = 4.5, height = 3.5)


#zero inflated model for ERCAL only
ERICAL_density_FAC <- shrub_density_long %>%
  filter(seed.resp == "SEEDLING") %>% 
  filter(fac.obl == "FAC") %>% 
  filter(spp == "ERICAL") 
unique(ERICAL_density_FAC$spp)

M2 <- zeroinfl(density_ha ~ as.factor(num_burn),
               dist = "negbin",
          data = ERICAL_density_FAC)
summary(M2)
#check for over/underdispersion
E3 <- resid(M2, type = "pearson")
N <- nrow(shrub_density_long)
p <- length(coef(M2))
sum(E3^2)/(N-p)
#.286 nooo 

mydf2 <- ggpredict(M2, type= "zi_random", terms = "num_burn") 
mydf2
ggplot(mydf2, aes(as.factor(x), predicted))+
  geom_point(size=3,position = position_dodge(.1), aes(color=as.factor(x))) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
              position = position_dodge(.1),
              width=.1, size=.3) +
  scale_colour_viridis_d()+
  xlab("Fire frequency")+
  ylab("ERICAL Seedling density/Ha")+
  theme_bw()+
  theme(legend.position = "none",
  axis.text = element_text(size=12),
  text = element_text(size = 14),
  panel.grid = element_blank())
ggsave(file="figures/ERICAL_seed_predicted.svg", width = 4.5, height = 3.5)
ggsave(file="figures/ERICAL_seed_predicted.png", width = 4.5, height = 3.5)

#zero inflated model for LEPCAL only
LEPCAL_density_FAC <- shrub_density_long %>%
  filter(seed.resp == "SEEDLING") %>% 
  filter(fac.obl == "FAC") %>% 
  filter(spp == "LEPCAL") 
unique(LEPCAL_density_FAC$spp)

M2 <- zeroinfl(density_ha ~ as.factor(num_burn),
               dist = "negbin",
          data = LEPCAL_density_FAC)
summary(M2)
#check for over/underdispersion
E3 <- resid(M2, type = "pearson")
N <- nrow(shrub_density_long)
p <- length(coef(M2))
sum(E3^2)/(N-p)
#.286 nooo 

mydf2 <- ggpredict(M2, type= "zi_random", terms = "num_burn") 
mydf2
ggplot(mydf2, aes(as.factor(x), predicted))+
  geom_point(size=3,position = position_dodge(.1), aes(color=as.factor(x))) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
              position = position_dodge(.1),
              width=.1, size=.3) +
  scale_colour_viridis_d()+
  xlab("Fire frequency")+
  ylab("LEPCAL Seedling density/Ha")+
  theme_bw()+
  theme(legend.position = "none",
  axis.text = element_text(size=12),
  text = element_text(size = 14),
  panel.grid = element_blank())
ggsave(file="figures/LEPCAL_seed_predicted.svg", width = 4.5, height = 3.5)
ggsave(file="figures/LEPCAL_seed_predicted.png", width = 4.5, height = 3.5)


```

# RANDOM FOREST - SHRUB DENSITY

```{r RF shrub den}

library(randomForest)
library(party)
library(stablelearner)

#####DENSITY
shrub_density_long <- read.csv("data/clean/LNU_subplot_shrub_density_long.csv")
shrub_density_long <- left_join(shrub_density_long, plot.description_LNU, by="PlotID")
shrub_density_long <- left_join(shrub_density_long, species.short, by ="spp")
str(shrub_density_long)
#make num_burn categorical
shrub_density_long$num_burn <- as.factor(shrub_density_long$num_burn)
shrub_density_long$preFireYear <- as.factor(shrub_density_long$preFireYear)
shrub_density_long$mCC_FRI <- as.factor(shrub_density_long$mCC_FRI)
shrub_density_long$aspect_name <- as.factor(shrub_density_long$aspect_name)
shrub_density_long$TSLF <- as.factor(shrub_density_long$TSLF)
shrub_density_long$spp <- as.factor(shrub_density_long$spp)
shrub_density_long$Site <- as.factor(shrub_density_long$Site)


#OBLIGATE SEEDERS
shrub_density_OBLS <- shrub_density_long %>%
  filter(PFR == "chaparral and serotinous conifer") %>% 
  filter(avg.sum == "sum.count") %>% 
  filter(seed.resp == "SEEDLING") %>% 
  filter(fac.obl == "OBL-S") %>% 
  filter(spp != "ACMGLA") %>% 
  mutate(presence = case_when(
    density == 0 ~ 0,
    density > 0 ~ 1
  ))

unique(shrub_density_OBLS$spp)
unique(shrub_density_OBLS$TSLF)
unique(shrub_density_OBLS$presence)
str(shrub_density_OBLS)

shrub_density_OBLS$presence <- as.factor(shrub_density_OBLS$presence)

OBLS_den_short <- shrub_density_OBLS %>% 
  dplyr::select(presence, num_burn,
                mCC_FRI, ppt, tmean, elevation, slope, aspect_name, hli, TSLF)
str(OBLS_den_short)

library(party)
library(partykit)
library(rpart)
library(rpart.plot)
#run random forest model
ctree1 <- ctree(presence ~ num_burn + elevation + aspect_name + TSLF,
                    data = OBLS_den_short)
                    controls= ctree_control (testtype = c("Bonferroni"), 
                                             mincriterion = 0.95))
ctree1
plot(ctree1)

rpartv1 <- rpart(presence ~ num_burn + ppt + tmean + aspect_name + elevation,
                    data = OBLS_den_short,
                    method = "class", 
                    control = rpart.control(cp=.2))
rpart.plot(rpartv1)
summary(rpartv1)
#prediction of fitted mean and visualization
plot(presence ~., data = OBLS_den_short)
cf1 <- stablelearner::as.stabletree(cforest1)
summary(cf1, original = FALSE)
barplot(cf1)




#Facultative seeders
shrub_density_FAC <- shrub_density_long %>%
  filter(seed.resp == "SEEDLING") %>% 
  filter(fac.obl == "FAC") %>% 
  filter(spp != "MIMAUR") %>% 
    filter(spp != "HOLDIS") 
unique(shrub_density_FAC$spp)


```


#Shrub Cover

```{r}

str(shrub_cover)
shrub_cover <- left_join(shrub_cover, severity.plotdescription.LNU, by="PlotID")
shrub_cover <- left_join(shrub_cover, species.short, by ="spp")
shrub_cover$num_burn <- as.numeric(shrub_cover$num_burn)
shrub_cover$cover <- as.numeric(shrub_cover$cover)

shrub_cover %>%
  filter(seed.resprout == "SEEDLING") %>% 
  filter(spp == "ERICAL"|
           spp == "ADFA" |
           spp == "LEPCAL"|
           spp == "CEACUN"|
           spp == "CEAOLI"|
           spp == "ARCMAN") %>%
ggplot(aes(x=num_burn, y=cover, col = spp))+
    geom_smooth(method="lm", se=F)

shrub_cover %>%
  filter(seed.resprout == "RESPROUT") %>% 
  
ggplot(aes(x=num_burn, y=cover, col = spp))+
    geom_smooth(method="lm", se=F)

    
    
    
    sh_count <- left_join(sh_count, plot.description.short, by="PlotID")
   sh_count <- left_join(sh_count, species.short, by ="spp")
    sh_count$num_burn <- as.numeric(sh_count$num_burn)
    sh_count$density <- as.numeric(sh_count$density)
    
    ggplot(data=sh_count, aes(x=num_burn, y=density, colour=spp))+
      geom_smooth(method = "lm")
    
    
```















