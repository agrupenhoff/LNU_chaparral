---
title: "LNU Analysis"
author: "Ashley Grupenhoff"
date: "5/6/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/ashle/OneDrive/Documents/R/LNU_chaparral/LNU_chaparral")
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(plyr)
library(brms)
library(rstan)
library(tidybayes)
library(bayesplot)
library(bayestestR)
library(emmeans)
library(calecopal)
library(modelr)
library(brmsmargins)
library(ROCR) #calculate area under curve
library(stringr) #str_detect
library(forcats) #fct_rev
library(ggridges)
library(broom)            # Convert model objects to data frames
library(broom.mixed)   
library(corrplot)
#run faster
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

```

## Input clean data
```{r data}
#raw
TOT_species_LNU <- read.csv("data/raw/TOT_species_LNU.csv")
subplot_species_LNU <- read.csv("data/raw/SubPlot_SPP_LNU.csv")
severity_LNU <- read.csv("data/raw/Severity_LNU.csv")
GroundCover_LNU <- read.csv("data/raw/GroundCover_LNU.csv")
Mortality_LNU <- read.csv("data/raw/Mortality_LNU.csv")

plot.description_LNU <- read.csv("data/clean/LNU_plot_description_CLEAN.csv")
SpeciesList <- read.csv("data/raw/SpeciesList_jan23.csv")

species.short <- SpeciesList %>% 
  dplyr::select(spp, Lifeform, Native_nonnative, fac.obl) 


plyr::count(plot.description_LNU$cool_warm_slope)

range(plot.description_LNU$ppt)
hist(plot.description_LNU$ppt)

range(plot.description_LNU$tmean)
hist(plot.description_LNU$tmean)

range(plot.description_LNU$hli)
range(plot.description_LNU$slope)

unique(plot.description_LNU$Geology)


#collinearity

data <- plot.description_LNU[ , c("num_burn", "ppt", "tmean", "elevation", "hli", "TSLF")]
cor(data) #this looks good!!
#Spearmanâ€™s Rank Correlation Coefficients
pairs(data)

correlation_matrix <- cor(data)

corrplot(cor(data),# Correlation matrix
         method = "circle", # Correlation plot method
         type = "lower",    # Correlation plot style (also "upper" and "lower")
         diag = TRUE,      # If TRUE (default), adds the diagonal
         tl.col = "black", # Labels color
         bg = "white",     # Background color
         title = "",       # Main title
         col = NULL)       # Color palette



```



## Severity 

```{r severity}


severity_LNU_clean <- severity_LNU %>% 
  group_by(PlotID, year) %>% 
  dplyr::summarise(mean_diam_mm = mean(Mean_diam),
            sd = sd(Mean_diam),
            n_obs = n(),
            se = sd/sqrt(n_obs),
            max_diam_mm = max(Mean_diam))

severity.plotdescription.LNU <- left_join(severity_LNU_clean, 
                                          plot.description_LNU, by="PlotID")


sevdata <- ddply(severity.plotdescription.LNU, c("num_burn"),
                 summarise,
                 N = sum(!is.na(mean_diam_mm)),
                 mean_diam_mm_avg = mean(mean_diam_mm, na.rm=TRUE),
                 sd= sd(mean_diam_mm, na.rm = TRUE),
                 se = sd/sqrt(N),
                 cv = 100*sd/mean_diam_mm_avg,
                 
                 max = mean(max_diam_mm, na.rm = TRUE),
                 sd_max = sd(max_diam_mm, na.rm = TRUE),
                 se_max = sd_max/sqrt(N),
                 cv_max = 100*sd_max/max
                 ) 


ggplot(data=sevdata %>%  
         filter(num_burn != "2"), 
       aes(x=as.factor(num_burn), y=mean_diam_mm_avg))+
  geom_bar(stat = "identity", aes(fill= as.factor(num_burn)))+
  geom_errorbar(aes(ymin=mean_diam_mm_avg-se, ymax=mean_diam_mm_avg+se), width=.1, size=.7)+
  #geom_point(size=3, aes(colour=factor(num_burn)))+
  scale_fill_manual(values = cal_palette("sierra1")) +
                     xlab("Fire frequency")+
                     ylab("Fire Severity (mm)")+
                    theme_bw()+
                   theme(legend.title = element_blank(),
                           axis.text = element_text(size=15),
                            text = element_text(size = 16),
                          panel.grid = element_blank())
ggsave(file="figures/sev~freq.svg", width = 4.5, height = 3)
ggsave(file="figures/sev~freq.png", width = 4.5, height = 3)





#LINEAR MODEL
qqnorm(severity.plotdescription.LNU$mean_diam_mm, pch = 1, frame = FALSE)
qqline(severity.plotdescription.LNU$mean_diam_mm, col = "steelblue", lwd = 2)

m.sev <- lm(num_burn ~ mean_diam_mm ,
                 data = severity.plotdescription.LNU, REML = F)
summary(m.sev)
coef(summary(m.nativeRich))
plot(m.sev)

```

# Ground cover data

```{r}

str(GroundCover_LNU)
GroundCover_LNU$Litter_depth_cm <- as.numeric(GroundCover_LNU$Litter_depth_cm)
GroundCover_LNU$SH_ht_cm <- as.numeric(GroundCover_LNU$SH_ht_cm)
GroundCover_LNU$year <- as.factor(GroundCover_LNU$year)

groundcover_LNU <- left_join(GroundCover_LNU, 
                              plot.description_LNU, by="PlotID")

groundcover_LNU_clean <- groundcover_LNU %>% 
  select(PlotID, year, num_burn, rock_percent, BG_percent, litter_percent,
         Litter_depth_cm, SH_cover_percent, SH_ht_cm, HB_cover_percent) %>% 
  group_by(num_burn, year) %>% 
  dplyr::summarise_if(is.numeric, 
                      funs(mean(., na.rm=T), 
                           n = sum(!is.na(.)), 
                           se = sd(., na.rm=T)/sqrt(sum(!is.na(.))))) 
  
ggplot(data=groundcover_LNU_clean,
       aes(x=num_burn, y=HB_cover_percent_mean))+
  geom_bar(stat = "identity", aes(fill= as.factor(num_burn)))+
  #geom_errorbar(aes(ymin=litter_percent_mean - litter_percent_se, 
  #                  ymax=litter_percent_mean + litter_percent_se), 
  #                width=.1, linewidth=.7)+
  facet_wrap(~year)+
  #geom_point(size=3, aes(colour=factor(num_burn)))+
  scale_fill_manual(values = cal_palette("sierra1")) +
  #                   xlab("Fire frequency")+
  #                   ylab("Rock  %")+
             
                   theme(legend.title = element_blank(),
                           axis.text = element_text(size=15),
                            text = element_text(size = 16),
                          panel.grid = element_blank())


```


# NMDS

Updated april 17, 2023

```{r}
library(vegan)

LNU_combine_wide <- read.csv("data/clean/LNU_species_all_wide.csv")

#make community matrix on which to base ordination
LNUspecies = LNU_combine_wide %>% select(!c("plot_year","X")) 

#columns that contain descriptive data
LNUplot_ord = LNU_combine_wide %>% 
  select(plot_year) %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

plot.description.short <- plot.description_LNU %>% 
  select(PlotID, num_burn, ppt, tmean, hli, cool_warm_slope, TSLF)

LNUplot_env <- left_join(LNUplot_ord, plot.description.short %>% distinct(), by = "PlotID")

set.seed(123) #reproduce same results
NMDS <- metaMDS(LNUspecies, distance="bray", k=3) #no transformation of species data is made here prior to bray curtis dissimilarities being calculated. 
NMDS

LNU.envfit <- envfit(NMDS, LNUplot_env, permutations = 999) # this fits environmental vectors


#env.fit
nmds_plot <- cbind(NMDS$point, LNUplot_env)
nmds_species <- cbind(as.data.frame(NMDS$species), 
                      as.data.frame(row.names(as.data.frame(NMDS$species)))) %>% 
                       dplyr::rename(spp = "row.names(as.data.frame(NMDS$species))")
nmds_species <- left_join(nmds_species, species.short, by = "spp")
nmds_plot$num_burn <- as.factor(nmds_plot$num_burn)


#significant species 
LNU.spp.fit <- envfit(NMDS, LNUspecies, permutations = 999 )
spp.scrs <- as.data.frame(scores(LNU.spp.fit, display = "vectors")) 
          #save species intrinsic values into dataframe
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs)) 
          #add species names to dataframe
spp.scrs <- cbind(spp.scrs, pval = LNU.spp.fit$vectors$pvals) 
            #add pvalues to dataframe so you can select species which are significant
sig.spp.scrs <- subset(spp.scrs, pval<=0.05) #subset data to show species significant at 0.05

head(spp.scrs)


ggplot(nmds_plot, aes(x=MDS1, y=MDS2))+
 geom_point(size = 4, aes(x=MDS1, y=MDS2, color = num_burn))+
  geom_segment(data = sig.spp.scrs, 
               aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), 
               colour = "grey10", lwd=0.3) +
  #add vector arrows of significant species
   ggrepel::geom_text_repel(data = sig.spp.scrs, 
                            aes(x=NMDS1, y=NMDS2, label = Species), 
                            cex = 3, direction = "both", segment.size = 0.25)+ 
  #add labels for species, use ggrepel::geom_text_repel so that labels do not overlap
  #geom_point(data= nmds_species, size = 1.8, alpha = 0.5, aes(x=MDS1, y=MDS2, 
  #                                               shape = Native_nonnative))+
  stat_ellipse(aes(x=MDS1, y=MDS2, color = num_burn))+
  scale_color_viridis_d(option = "magma")+
  guides(col=guide_legend("Fire Frequency"))+
  theme(axis.text = element_text(size=15),
        text = element_text(size = 16),
        panel.grid = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size=11))

ggsave(file="figures/NMDS.svg", width = 10, height = 6)
ggsave(file="figures/NMDS.png", width = 10, height = 6)



```



# prepare Richness file

Calculated richness by each sub plot probably want to do this by total plot?

```{r Richness, echo=FALSE}
#calculate richness

LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")

#sum up the number of non-zero entries per row 
#first column ignored ([,-1]) since this is the site name, not species count
LNU_richness_nonnative <- ddply(LNU_sub_nonnative_wide,~plot_year,function(x) {
  data.frame(NONNATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness_native <- ddply(LNU_sub_native_wide,~plot_year,function(x) {
  data.frame(NATIVE_RICHNESS=sum(x[-2]>0.0))})

LNU_richness <- left_join(LNU_richness_native, LNU_richness_nonnative, by="plot_year")

LNU_richness_proportion_5m2 <- LNU_richness %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  mutate(prop.native = (NATIVE_RICHNESS/(NATIVE_RICHNESS + NONNATIVE_RICHNESS))) %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 


LNU_richness_final_5m2 <- left_join(LNU_richness_proportion_5m2, plot.description_LNU, by="PlotID")

write.csv(LNU_richness_final_5m2, "data/clean/LNU_subplot_RICHNESS_5m2.csv")

            
```

# prepare diversity file 

```{r}
#calculate richness

LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")

LNU_sub_nonnative_wide <- LNU_sub_nonnative_wide %>% 
  dplyr::select(!X)
LNU_sub_native_wide <- LNU_sub_native_wide %>% 
  dplyr::select(!X)


#sum up the number of non-zero entries per row 
#first column ignored ([,-1]) since this is the site name, not species count

LNU_shanDiv_nonnative <- ddply(LNU_sub_nonnative_wide,~plot_year,function(x) {
  data.frame(NONNATIVE_SHANNON=diversity(x[-1], index="shannon"))
  })

LNU_shanDiv_native <- ddply(LNU_sub_native_wide,~plot_year,function(x) {
  data.frame(NATIVE_SHANNON=diversity(x[-1], index="shannon"))
  })

LNU_shan <- left_join(LNU_shanDiv_native, LNU_shanDiv_nonnative, by="plot_year")

LNU_shan_proportion_5m2 <- LNU_shan %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
  mutate(prop.nativeshan = (NATIVE_SHANNON/(NATIVE_SHANNON + NONNATIVE_SHANNON)))  %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 


LNU_shan_final_5m2 <- left_join(LNU_shan_proportion_5m2, plot.description_LNU, by="PlotID")


write.csv(LNU_shan_final_5m2, "data/clean/LNU_subplot_SHANNON_5m2.csv")

```

#prepare total cover file (proportion)

```{r}
LNU_sub_nonnative_wide <- read.csv("data/clean/LNU_subplot_nonnative_wide.csv")
LNU_sub_native_wide <- read.csv("data/clean/LNU_subplot_native_wide.csv")
str(LNU_sub_nonnative_wide)

LNU_nonnative <- LNU_sub_nonnative_wide %>% 
    dplyr::select(!(X)) %>% 
    dplyr::mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   dplyr::select(plot_year, sum) %>% 
    dplyr::rename(nonnative_cover = sum)

LNU_native <- LNU_sub_native_wide %>% 
    dplyr::select(!(X)) %>% 
    dplyr::mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   dplyr::select(plot_year, sum) %>% 
    dplyr::rename(native_cover = sum)

LNU_cover <- left_join(LNU_native, LNU_nonnative, by="plot_year")
head(LNU_cover)

LNU_cover_clean <- LNU_cover %>% 
  mutate_if(is.numeric, ~replace_na(.,0)) %>% 
   mutate(prop_native_cover = (native_cover/
                                 (native_cover + nonnative_cover))) %>% 
   pivot_longer(!plot_year,
               names_to = "native.nonnative.prop",
               values_to = "cover") %>% 
  separate(plot_year, c("PlotID", "year"), sep="_") 

head(LNU_cover_clean)

LNU_cover_final <- left_join(LNU_cover_clean, plot.description_LNU, by="PlotID")

write.csv(LNU_cover_final, "data/clean/LNU_speciesCover_FINAL.csv")


```





# seedling density values - visualize

```{r}

#####DENSITY

shrub_seedling_data <- read.csv("data/clean/shrub_seedling_data_ALL.csv")

seedling_data <- left_join(shrub_seedling_data, plot.description_LNU, by="PlotID")
seedling_data <- left_join(seedling_data, species.short, by ="spp")

#check data
seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  ggplot(aes(x=num_burn, y=count.250m2, color=spp))+
  geom_smooth(method = "lm")+
  geom_point()+
  geom_jitter()+
  facet_wrap(~fac.obl)


#check numbe of 0s
100*sum(shrub_density_long$density == 0)/nrow(shrub_density_long)

##Visualize data
str(seedling_data)
#shrub_density_total$num_burn <- as.factor(shrub_density_total$num_burn)

shrub_density_sum <- seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  group_by(num_burn, fac.obl) %>% 
  dplyr::summarise(mean_den = mean(count.250m2),
            max_den = max(count.250m2),
            min_den = min(count.250m2),
            n_obs = n(),
            sd = sd(count.250m2),
            se= sd/sqrt(n_obs))

ggplot(shrub_density_sum, 
       aes(x=as.factor(num_burn), y=mean_den, fill=fac.obl))+
  geom_bar(stat = "identity", position = position_dodge())+
  scale_fill_manual(values = cal_palette("sierra1")) +
  geom_errorbar(aes(ymax=mean_den + se, ymin=mean_den-se),
                width=.2,
                position=position_dodge(.9))+
  labs(x="Fire Frequency", y= "Average seedling density",
       fill="")+
   theme(legend.position = "bottom")+
  theme(panel.background = element_rect(fill = "white", colour = NA),
        panel.grid.major = element_line(colour = "gray90", size = 0.5),
        panel.grid.minor = element_line(colour = "gray90", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank(),
        legend.text=element_text(size=12))


#BY SPECIES 
shrub_density_spp <- seedling_data %>% 
  filter(fac.obl == "FAC"|
           fac.obl == "OBL-S") %>% 
  filter(spp != "TOXDIV") %>% 
    filter(spp != "MIMAUR") %>% 
     filter(spp != "RIBMAL") %>% 
  group_by(num_burn, fac.obl, spp) %>% 
  dplyr::summarise(mean_den = mean(count.250m2),
            max_den = max(count.250m2),
            min_den = min(count.250m2),
            n_obs = n(),
            sd = sd(count.250m2),
            se= sd/sqrt(n_obs))

ggplot(shrub_density_spp, 
       aes(x=as.factor(num_burn), y=mean_den))+
  facet_wrap(~fac.obl)+
  geom_bar(stat = "identity", aes(fill=spp))+
  #geom_errorbar(aes(ymax=mean_den + se, ymin=mean_den - se),
  #              width=.2, position = "identity")+
   labs(x="Fire Frequency", y= "Average seedling density",
       fill="")+
  theme(legend.position = "bottom")+
  scale_fill_viridis_d()+
  theme(panel.background = element_rect(fill = "white", colour = NA),
        panel.grid.major = element_line(colour = "gray90", size = 0.5),
        panel.grid.minor = element_line(colour = "gray90", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank(),
        legend.text=element_text(size=12))


```


# Seedling Density Regression Obligate seeders

use bernoulli prior and constrain the priors

prior1 <- prior("normal(0,1)", class = "b") +
  prior("student_t(3, 0, 1)", class = "sds", coef = "s(transect_dist_m, by = Plot)")
  # only 1 coef for this. t(3,0,1) is aki vehtarhi's favorite weakly informative prior.
  I changed this from t(3, 0, 2.5)


when no prior used, model cannot be fit, rhat ~1.04 and very low estimated sample size. This is probably because one or more of the predictors causes full separation of the outcome. See page 256 of Regression and other stories for more information.


```{r Seedling Density OBLIGATE-S }


#####DENSITY

shrub_seedling_data <- read.csv("data/clean/shrub_seedling_data_ALL.csv")

seedling_data <- left_join(shrub_seedling_data, plot.description_LNU, by="PlotID")
seedling_data <- left_join(seedling_data, species.short, by ="spp")



hist(seedling_data$avg.count)
hist(seedling_data$prop.presence)
mean(seedling_data$avg.count) #.101
mean(seedling_data$prop.presence) #.022
sd(seedling_data$avg.count) #.768
sd(seedling_data$prop.presence) #.099

#look at OBL-S only
str(shrub_density_OBLS)
range(shrub_density_OBLS$prop.presence)

shrub_density_OBLS <- seedling_data %>%
  filter(fac.obl == "OBL-S") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))

shrub_density_OBLS$year <- as.factor(shrub_density_OBLS$year)

plot(shrub_density_OBLS$num_burn, shrub_density_OBLS$presence)
plot(shrub_density_OBLS$TSLF, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$hli, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$ppt, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$tmean, shrub_density_OBLS$prop.presence)
plot(shrub_density_OBLS$elevation, shrub_density_OBLS$prop.presence)

shrub_density_OBLS %>% 
  dplyr::count(prop.presence == 0) %>% 
  mutate(prop = n/sum(n)) 

cor(shrub_density_OBLS[,c("num_burn","TSLF",
                          "hli","slope",
                          "ppt","tmean","elevation")])
pairs(shrub_density_OBLS[,c("num_burn","TSLF",
                          "hli","slope",
                          "ppt","tmean","elevation")])

ggplot(shrub_density_OBLS, aes(x=num_burn, y=presence,
                               color=spp))+
  geom_point()+
  geom_jitter()


priors <- c(set_prior("normal(0,1)", class = "b"),
            set_prior("student_t(3, 0, 1)", class = "Intercept"))
  # only 1 coef for this. t(3,0,1) is aki vehtarhi's favorite weakly informative prior.
 # I changed this from t(3, 0, 2.5)
prior_summary(m.shrubDensityOBL)
m.shrubDensityOBL <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL, file = "models/shrubDensityOBL.rda")
load("models/shrubDensityOBL.rda")

tidy(m.shrubDensityOBL, effects = "fixed")
summary(m.shrubDensityOBL)
conditional_effects(m.shrubDensityOBL)
plot(m.shrubDensityOBL)
pp_check(m.shrubDensityOBL)
bayes_R2(m.shrubDensityOBL)

m.shrubDensityOBL2 <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn * year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL2, file = "models/shrubDensityOBL2.rda")
load("models/shrubDensityOBL2.rda")

summary(m.shrubDensityOBL2b)
conditional_effects(m.shrubDensityOBL2b)
plot(m.shrubDensityOBL2)
pp_check(m.shrubDensityOBL2)
bayes_R2(m.shrubDensityOBL2b)
loo(m.shrubDensityOBL,m.shrubDensityOBL2b)


m.shrubDensityOBL2b <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL2b, file = "models/shrubDensityOBL2b.rda")
load("models/shrubDensityOBL2b.rda")

loo(m.shrubDensityOBL,m.shrubDensityOBL2b)

m.shrubDensityOBL3 <- brm(data = shrub_density_OBLS,
                      presence ~ 1 + num_burn + year + cool_warm_slope,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityOBL3, file = "models/shrubDensityOBL3.rda")
load("models/shrubDensityOBL3.rda")

summary(m.shrubDensityOBL2b)
conditional_effects(m.shrubDensityOBL3)
plot(m.shrubDensityOBL3)
pp_check(m.shrubDensityOBL3)
bayes_R2(m.shrubDensityOBL3)
loo(m.shrubDensityOBL, m.shrubDensityOBL2b, m.shrubDensityOBL3)


pred <- m.shrubDensityOBL2b %>% 
  epred_draws(newdata = expand_grid(num_burn=seq(1,7,by=.1),
                                    year=c(2021,2022)))
pred

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of obligate seeder",
       fill = "Credible interval") +
  facet_wrap(~year)+
  theme(legend.position = "bottom")+
    theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 13),
        axis.text.x = element_text(size = 10),
        legend.title = element_blank())


#CREATE FIGURE

nd <- shrub_density_OBLS %>% 
 data_grid(num_burn=seq(1,7,by=.01),
            year=c(2021, 2022))

OBL.fitted <- 
    fitted(m.shrubDensityOBL2b, 
           newdata= nd,
           scale = "response",
           probs = c(0.05, 0.95)) %>% 
    as.data.frame() %>% 
    cbind(nd)


 OBL.plot <- ggplot(OBL.fitted, aes(x=num_burn))+
      geom_smooth(aes(y = Estimate, 
                     ymin = Q5, ymax = Q95,
                    fill = as.factor(year), 
                    color = as.factor(year)),
                      stat = "identity", 
                      alpha = 1/4, size = 1/2)+
          geom_point(aes(y = Estimate, color = as.factor(year)),
                     size = 2/3)+
    #geom_point(data=LNU_cover_prop, 
    #           aes(x=num_burn, y=cover),alpha=.2)+
    #geom_jitter(data=LNU_cover_prop, 
    #            aes(x=num_burn, y=cover), alpha =.2)+
    xlim(1,6)+
    #facet_wrap(~year)+
     labs(x="Fire Frequency", y= "Proability of occurence",
       fill="credible interval")+
 scale_color_manual(values = c("mediumpurple", "seagreen4")) +
 scale_fill_manual(values = c("mediumpurple", "seagreen4")) +
  theme(legend.position = "bottom")+
   theme(panel.background = element_rect(fill = "white", colour = NA),
        panel.grid.major = element_line(colour = "gray90", size = 0.5),
        panel.grid.minor = element_line(colour = "gray90", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank(),
        legend.text=element_text(size=12))+
    guides(fill = FALSE)
 OBL.plot


```

# Shrub density FACULTATIVE

```{r}
####### Facultative
shrub_density_FAC <- seedling_data %>%
  filter(fac.obl == "FAC") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence)) 

unique(shrub_density_FAC$spp)
shrub_density_FAC$year <- as.factor(shrub_density_FAC$year)
ggplot(shrub_density_FAC, aes(x=num_burn, y=presence,
                               color=spp))+
  geom_point()+
  geom_jitter()

m.shrubDensityFAC <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC, file = "models/shrubDensityFAC.rda")
load("models/shrubDensityFAC.rda")

tidy(m.shrubDensityFAC, effects = "fixed")
summary(m.shrubDensityFAC)
conditional_effects(m.shrubDensityFAC)
plot(m.shrubDensityFAC)
pp_check(m.shrubDensityFAC)
bayes_R2(m.shrubDensityFAC)

pred <- m.shrubDensityFAC %>% 
  epred_draws(newdata = expand_grid(num_burn=seq(1,7,by=.1)))
pred

ggplot(pred, aes(x=num_burn, y=.epred))+
  stat_lineribbon()+
  scale_fill_brewer(palette = "Blues")+
  labs(x = "Fire frequency", 
       y = "Predicted presence of facultative seeder",
       fill = "Credible interval") +
  theme(legend.position = "bottom")

m.shrubDensityFAC2 <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC2, file = "models/shrubDensityFAC2.rda")
load("models/shrubDensityFAC2.rda")

summary(m.shrubDensityFAC2)
conditional_effects(m.shrubDensityFAC2)
plot(m.shrubDensityFAC2)
pp_check(m.shrubDensityFAC2)
bayes_R2(m.shrubDensityFAC2)
loo(m.shrubDensityFAC,m.shrubDensityFAC2)

m.shrubDensityFAC3 <- brm(data = shrub_density_FAC,
                      presence ~ 1 + num_burn + year + hli,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityFAC3, file = "models/shrubDensityFAC3.rda")
load("models/shrubDensityFAC3.rda")

summary(m.shrubDensityFAC3)
conditional_effects(m.shrubDensityFAC3)
plot(m.shrubDensityFAC3)
pp_check(m.shrubDensityFAC3)
bayes_R2(m.shrubDensityFAC3)
loo(m.shrubDensityFAC,m.shrubDensityFAC2, m.shrubDensityFAC3)


#CREATE FIGURE

nd <- shrub_density_FAC %>% 
 data_grid(num_burn=seq(1,7,by=.01),
            year=c(2021, 2022))

FAC.fitted <- 
    fitted(m.shrubDensityFAC2, 
           newdata= nd,
           scale = "response",
           probs = c(0.05, 0.95)) %>% 
    as.data.frame() %>% 
    cbind(nd)


 FAC.plot <- ggplot(FAC.fitted, aes(x=num_burn))+
      geom_smooth(aes(y = Estimate, 
                     ymin = Q5, ymax = Q95,
                    fill = as.factor(year), 
                    color = as.factor(year)),
                      stat = "identity", 
                      alpha = 1/4, size = 1/2)+
          geom_point(aes(y = Estimate, color = as.factor(year)),
                     size = 2/3)+
    #geom_point(data=LNU_cover_prop, 
    #           aes(x=num_burn, y=cover),alpha=.2)+
    #geom_jitter(data=LNU_cover_prop, 
    #            aes(x=num_burn, y=cover), alpha =.2)+
    xlim(1,6)+
    #facet_wrap(~year)+
     labs(x="Fire Frequency", y= "Proability of occurence",
       fill="credible interval")+
 scale_color_manual(values = c("mediumpurple", "seagreen4")) +
 scale_fill_manual(values = c("mediumpurple", "seagreen4")) +
  theme(legend.position = "bottom")+
     theme(panel.background = element_rect(fill = "white", colour = NA),
        panel.grid.major = element_line(colour = "gray90", size = 0.5),
        panel.grid.minor = element_line(colour = "gray90", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank(),
        legend.text=element_text(size=12))
    guides(fill = FALSE)

FAC.plot

```

# shrub density by individual FAC spp

```{r}
#ADFA ONLY
shrub_density_ADFA <- seedling_data %>%
  filter(spp == "ADFA") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_3top$year <- as.factor(shrub_density_3top$year)


m.shrubDensityADFA <- brm(data = shrub_density_ADFA,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityADFA, file = "models/shrubDensityADFA.rda")
load("models/shrubDensityADFA.rda")

summary(m.shrubDensityADFA)
conditional_effects(m.shrubDensityADFA)
bayes_R2(m.shrubDensityADFA)

unique(seedling_data$spp)
shrub_density_ERICAL <- seedling_data %>%
  filter(spp == "ERICAL") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_ERICAL$year <- as.factor(shrub_density_ERICAL$year)

plot(shrub_density_ERICAL$presence, shrub_density_ERICAL$num_burn)

m.shrubDensityERCAL <- brm(data = shrub_density_ERICAL,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityERCAL, file = "models/shrubDensityERCAL.rda")
load("models/shrubDensityERCAL.rda")

summary(m.shrubDensityERCAL)
conditional_effects(m.shrubDensityERCAL)

shrub_density_LEPCAL <- seedling_data %>%
  filter(spp == "LEPCAL") %>% 
   mutate(prop.presence= ifelse(prop.presence == 1, 0.999, prop.presence)) %>% 
  mutate(presence = ifelse(presence >0, 1, presence))
shrub_density_LEPCAL$year <- as.factor(shrub_density_LEPCAL$year)


m.shrubDensityLEPCAL <- brm(data = shrub_density_LEPCAL,
                      presence ~ 1 + num_burn + year,
                      family = bernoulli(),
                      control = list(adapt_delta = 0.998, max_treedepth = 15),
                      prior = priors,
                      sample_prior = TRUE,
                      iter = 2000,
                      warmup = 1000, 
                     cores = 4, chains = 4)

save(m.shrubDensityLEPCAL, file = "models/shrubDensityLEPCAL.rda")
load("models/shrubDensityLEPCAL.rda")
summary(m.shrubDensityLEPCAL)
conditional_effects(m.shrubDensityLEPCAL)

nd <- shrub_density_FAC %>% 
 data_grid(num_burn=seq(1,7,by=.01),
            year=c(2021, 2022))

FAC.fitted <- 
    fitted(m.shrubDensityFAC2, 
           newdata= nd,
           scale = "response",
           probs = c(0.05, 0.95)) %>% 
    as.data.frame() %>% 
    cbind(nd) %>% 
  mutate(spp = "COMBINE")

ADFA.fitted <- 
    fitted(m.shrubDensityADFA, 
           newdata= nd,
           scale = "response",
           probs = c(0.05, 0.95)) %>% 
    as.data.frame() %>% 
    cbind(nd)%>% 
  mutate(spp = "ADFA")
ERICAL.fitted <- 
    fitted(m.shrubDensityERCAL, 
           newdata= nd,
           scale = "response",
           probs = c(0.05, 0.95)) %>% 
    as.data.frame() %>% 
    cbind(nd)%>% 
  mutate(spp = "ERICAL")
LEPCAL.fitted <- 
    fitted(m.shrubDensityLEPCAL, 
           newdata= nd,
           scale = "response",
           probs = c(0.05, 0.95)) %>% 
    as.data.frame() %>% 
    cbind(nd)%>% 
  mutate(spp = "LEPCAL")

pred_all <- rbind(ADFA.fitted, LEPCAL.fitted, ERICAL.fitted)

 ggplot(pred_all, aes(x=num_burn))+
      geom_smooth(aes(y = Estimate, 
                     ymin = Q5, ymax = Q95,
                   fill = as.factor(year), 
                  color = as.factor(year)),
                      stat = "identity", 
                      alpha = 1/4, size = 1/2)+
          geom_point(aes(y = Estimate, 
                         color = as.factor(year)),
                     size = 2/3)+
    #geom_point(data=LNU_cover_prop, 
    #           aes(x=num_burn, y=cover),alpha=.2)+
    #geom_jitter(data=LNU_cover_prop, 
    #            aes(x=num_burn, y=cover), alpha =.2)+
    xlim(1,6)+
    facet_wrap(~spp, ncol = 2)+
     labs(x="Fire Frequency", y= "Proability of occurence",
       fill="credible interval")+
 scale_color_manual(values = c("mediumpurple", "seagreen4")) +
 scale_fill_manual(values = c("mediumpurple", "seagreen4")) +
  theme(legend.position = "bottom")+
  theme(panel.grid   = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(hjust = 0, size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 20),
        legend.title = element_blank(),
        legend.text=element_text(size=12))+
    guides(fill = FALSE)






  
```



# shrub resprout height

```{r}
#####RESP HEIGHT

shrub_resp_ht <- read.csv("data/clean/shrub_resprout_height_ALL.csv")

shrub_resp_ht <- left_join(shrub_resp_ht, plot.description_LNU, by="PlotID")
shrub_resp_ht <- left_join(shrub_resp_ht, species.short, by ="spp")

str(shrub_resp_ht)
shrub_resp_ht$num_burn <- as.factor(shrub_resp_ht$num_burn)

shrub_resp_ht %>% 
  filter(spp == "ADFA") %>% 
  ggplot(aes(x=num_burn, y=mean.ht))+
  geom_boxplot()
  geom_jitter()

```

